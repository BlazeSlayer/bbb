<!DOCTYPE html>
<html>
<head>
  <title>ScriptOS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.11.2/brython.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.0.4/typescript.min.js"></script>
  <style>
    /* --- Base Theme (Inspired by XeroLinux: Dark with blue/neon accents, modern KDE-like) --- */
    body {
      font-family: 'Poppins', sans-serif;
      overflow: hidden;
      background-color: #181825;
      color: #cdd6f4;
      transition: background-color 0.3s ease;
    }
    #desktop {
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      transition: background-image 0.5s ease-in-out;
    }
    /* --- Dock (Latte-like with blur and neon glow) --- */
    footer .dock-container {
      background-color: rgba(30, 30, 46, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid #313244;
      display: flex;
      align-items: center;
      transition: transform 0.2s ease;
      box-shadow: 0 4px 20px rgba(137, 180, 250, 0.2);
    }
    .dock-icon {
      transition: all 0.2s ease-in-out;
      cursor: pointer;
      position: relative;
      background-color: #1e1e2e;
      border-radius: 12px;
    }
    .dock-icon:hover {
      transform: translateY(-8px) scale(1.15);
      background-color: #313244;
      filter: drop-shadow(0 4px 6px rgba(137, 180, 250, 0.3));
    }
    .dock-icon .active-dot {
      display: none;
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background-color: #89b4fa;
      border-radius: 50%;
      box-shadow: 0 0 8px #89b4fa;
    }
    #dock-clock {
      color: #cdd6f4;
      font-family: 'Courier New', Courier, monospace;
      font-weight: 500;
      font-size: 0.9rem;
      margin-left: 1.5rem;
      margin-right: 0.5rem;
      padding: 4px 8px;
      background-color: rgba(30, 30, 46, 0.5);
      border-radius: 6px;
    }
    #dock-battery {
      color: #cdd6f4;
      font-size: 0.9rem;
      margin-left: 1rem;
      padding: 4px 8px;
      background-color: rgba(30, 30, 46, 0.5);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #dock-battery svg {
      width: 16px;
      height: 16px;
    }
    /* --- App Windows (With neon borders and glow) --- */
    .app-window {
      min-width: 320px;
      min-height: 250px;
      overflow: hidden;
      background-color: #1e1e2e;
      border: 1px solid #313244;
      box-shadow: 0 10px 20px rgba(137, 180, 250, 0.1);
      display: none;
      flex-direction: column;
      color: #cdd6f4;
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 0;
      transform: scale(0.95);
      border-radius: 12px;
    }
    .app-window.active {
      opacity: 1;
      transform: scale(1);
    }
    .window-header {
      cursor: move;
      flex-shrink: 0;
      background-color: #181825;
      border-bottom: 1px solid #313244;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .window-title {
      color: #cdd6f4;
    }
    .window-content {
      flex-grow: 1;
      background-color: #181825;
      overflow: auto;
      position: relative;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }
    
    /* --- Shared form styles --- */
    .dark-input {
      background-color: #181825;
      border: 1px solid #313244;
      color: #cdd6f4;
      transition: border-color 0.2s ease;
    }
    .dark-input:focus {
      outline: 2px solid #89b4fa;
      border-color: #89b4fa;
    }
    .dark-button-green {
      background-color: #a6e3a1;
      color: #181825;
      transition: background-color 0.2s ease;
    }
    .dark-button-green:hover {
      background-color: #94e2d5;
    }
    .dark-button-gray {
      background-color: #1e1e2e;
      border: 1px solid #313244;
      color: #cdd6f4;
      transition: background-color 0.2s ease;
    }
    .dark-button-gray:hover {
      background-color: #313244;
    }
    .dark-button-red {
      background-color: #f38ba8;
      color: #181825;
      transition: background-color 0.2s ease;
    }
    .dark-button-red:hover {
      background-color: #eba0ac;
    }
    
    /* --- Enhanced Loader --- */
    .loader {
      border: 4px solid #313244;
      border-top: 4px solid #89b4fa;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: -16px;
      margin-left: -16px;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    /* --- 8-WAY RESIZERS --- */
    .resizer {
      position: absolute;
      z-index: 90;
    }
    .resizer.top {
      top: -5px;
      left: 5px;
      right: 5px;
      height: 10px;
      cursor: n-resize;
    }
    .resizer.bottom {
      bottom: -5px;
      left: 5px;
      right: 5px;
      height: 10px;
      cursor: s-resize;
    }
    .resizer.left {
      left: -5px;
      top: 5px;
      bottom: 5px;
      width: 10px;
      cursor: w-resize;
    }
    .resizer.right {
      right: -5px;
      top: 5px;
      bottom: 5px;
      width: 10px;
      cursor: e-resize;
    }
    .resizer.top-left {
      top: -5px;
      left: -5px;
      width: 10px;
      height: 10px;
      cursor: nwse-resize;
    }
    .resizer.top-right {
      top: -5px;
      right: -5px;
      width: 10px;
      height: 10px;
      cursor: nesw-resize;
    }
    .resizer.bottom-left {
      bottom: -5px;
      left: -5px;
      width: 10px;
      height: 10px;
      cursor: nesw-resize;
    }
    .resizer.bottom-right {
      bottom: -5px;
      right: -5px;
      width: 10px;
      height: 10px;
      cursor: nwse-resize;
    }

    /* --- NEW Camera App Styles --- */
    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background-color: #000;
    }
    #camera-canvas {
      display: none;
    }
    .camera-controls {
      background-color: #1e1e2e;
      border-top: 1px solid #313244;
      padding: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }
    .camera-button {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .camera-capture {
      background-color: #f38ba8;
      color: #181825;
      font-size: 16px;
    }
    .camera-capture:hover {
      background-color: #eba0ac;
      transform: scale(1.05);
    }
    .camera-toggle {
      background-color: #1e1e2e;
      border: 1px solid #313244;
      color: #cdd6f4;
    }
    .camera-toggle:hover {
      background-color: #313244;
    }
    .camera-photos {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 8px;
      background-color: #181825;
    }
    .camera-photo {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    .camera-photo:hover {
      border-color: #89b4fa;
      transform: scale(1.1);
    }
    .camera-error {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      background-color: #1e1e2e;
      color: #f38ba8;
      text-align: center;
      padding: 20px;
    }

    /* --- Enhanced Chat App Styles --- */
    #chat-messages {
      display: flex;
      flex-direction: column;
      gap: 0px;
    }

    .message-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      max-width: 90%;
    }
    .message-wrapper.self {
      margin-left: auto;
      flex-direction: row-reverse;
    }
    .message-wrapper.other {
      margin-right: auto;
    }
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
      background-color: #313244;
      object-fit: cover;
    }
    .chat-message {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 100%;
      width: fit-content;
      text-wrap: wrap;
      word-break: break-word;
    }
    .chat-message p {
      margin: 0;
      color: #cdd6f4;
    }
    .chat-message .sent-image {
      max-width: 250px;
      max-height: 250px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 5px;
      cursor: pointer;
    }
    
    .self-message {
      background-color: #89b4fa;
      border-radius: 18px 18px 4px 18px;
      margin-left: 0;
    }
    .self-message p, .self-message .timestamp {
      color: #181825;
    }
    
    .other-message {
      background-color: #1e1e2e;
      border-radius: 18px 18px 18px 4px;
      margin-right: 0;
    }
    
    .chat-message .username {
      display: block;
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #a6adc8;
    }
    
    .self-message .username {
      color: #181825;
    }
    .other-message .username {
      color: #89b4fa;
    }

    .chat-message .timestamp {
      display: block;
      font-size: 0.7rem;
      text-align: right;
      margin-top: 4px;
      color: #6c7086;
    }
    .self-message .timestamp {
      color: #313244;
    }

    /* Role-specific bubble borders */
    .chat-message.admin {
      border: 2px solid #cba6f7;
      box-shadow: 0 0 8px rgba(203, 166, 247, 0.5);
    }
    .chat-message.admin .username {
      color: #cba6f7;
    }

    .chat-message.moderator {
      border: 2px solid #f9e2af;
      box-shadow: 0 0 8px rgba(249, 226, 175, 0.5);
    }
    .chat-message.moderator .username {
      color: #f9e2af;
    }

    .chat-message.canceled {
      border: 2px solid #f38ba8;
      opacity: 0.8;
    }
    .chat-message.canceled .username {
      color: #f38ba8;
      text-decoration: line-through;
    }
    .chat-message.canceled p {
      color: #a6adc8;
      font-style: italic;
    }
    
    .chat-message.contributor {
      border: 2px solid #a6e3a1;
      box-shadow: 0 0 8px rgba(166, 227, 161, 0.5);
    }
    .chat-message.contributor .username {
      color: #a6e3a1;
    }

    /* Chat Sidebar Styles */
    .chat-container {
      flex-direction: row;
      overflow: hidden;
    }
    .chat-sidebar {
      background-color: #181825;
      flex-shrink: 0;
    }
    .chat-main {
      background-color: #181825;
    }
    .user-list-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #313244;
      transition: background-color 0.2s;
    }
    .user-list-item:hover {
      background-color: #1e1e2e;
    }
    .user-list-item.active {
      background-color: #89b4fa;
      color: #181825 !important;
    }
    .user-list-item.active .text-gray-200,
    .user-list-item.active .text-gray-400 {
      color: #181825 !important;
      font-weight: bold;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .status-online {
      background-color: #a6e3a1;
    }
    .status-offline {
      background-color: #6c7086;
    }
    #chat-header {
      background-color: #1e1e2e;
    }

    .chat-v-resizer {
      flex-shrink: 0;
      width: 5px;
      background: #313244;
      cursor: col-resize;
      transition: background 0.2s;
    }
    .chat-v-resizer:hover {
      background: #89b4fa;
    }
    .chat-h-resizer {
      flex-shrink: 0;
      height: 5px;
      background: #313244;
      cursor: row-resize;
      transition: background 0.2s;
    }
    .chat-h-resizer:hover {
      background: #89b4fa;
    }

    /* --- Weather App Styles (Updated for theme) --- */
    #weather-app-container * {
      box-sizing: border-box;
      padding: 0;
      margin: 0;
      font-family: 'Poppins', sans-serif;
    }
    :root {
      --orange-color: #fab387;
      --dark-color: #cdd6f4;
      --light-color: #181825;
      --background: rgba(30, 30, 46, 0.9);
      --box_shadow: rgba(0, 0, 0, 0.5);
      --border: rgba(255, 255, 255, 0.1);
    }
    #weather-app-container .weather-container {
      width: 90%;
      max-width: 450px;
      height: auto;
      background: var(--background);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      flex-direction: column;
      justify-content: center;
      border-radius: 1rem;
      box-shadow: 0 10px 20px var(--box_shadow);
      padding: 20px;
    }
    .search_box {
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      border-radius: 3rem;
      padding: 0.5rem 0.5rem;
      backdrop-filter: blur(4px) saturate(180%);
      box-shadow: 0 5px 10px var(--box_shadow);
      margin-top: 1rem;
      margin-bottom: 2rem;
    }
    .search_box input {
      background: transparent;
      flex: 1;
      border: 0;
      outline: none;
      padding: 0 1rem;
      font-size: 1.4rem;
      color: var(--dark-color);
    }
    .search_box input::placeholder {
      color: var(--dark-color);
      opacity: 0.7;
    }
    .search_box button {
      border: 0;
      border-radius: 50%;
      background: var(--orange-color);
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .search_box .icon-svg {
      width: 18px;
      height: 18px;
      color: var(--light-color);
    }
    .error {
      margin: 4rem 0 5rem 0;
      color: #f38ba8;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 1.2rem;
      letter-spacing: 0.1rem;
      text-align: center;
    }
    #show {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #show h2 {
      color: var(--dark-color);
      text-transform: uppercase;
      letter-spacing: 0.1rem;
      font-weight: 600;
      font-size: 2rem;
      margin: 1rem 0;
    }
    .weather,
    .desc {
      color: var(--dark-color);
      text-transform: uppercase;
      letter-spacing: 0.1rem;
      font-size: 1.2rem;
      font-weight: 600;
      line-height: 1.5rem;
    }
    .weather {
      margin: 0.5rem 0;
    }
    #show img {
      margin: 1rem 0 0 0;
      width: 80px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
    }
    #show h1 {
      font-size: 5rem;
      margin: 1rem 0;
      line-height: 1;
      font-weight: 400;
      color: var(--dark-color);
    }
    .temp_container {
      display: flex;
      justify-content: center;
      margin: 2rem 0 3rem 0;
      text-align: center;
      width: 100%;
    }
    .temp_container div {
      padding: 0.5rem 1rem;
      flex: 1;
    }
    .temp_container div:first-child {
      border-right: 1px solid var(--border);
    }
    .temp_container .title {
      font-weight: 600;
      color: var(--dark-color);
      font-size: 1.4rem;
      margin-bottom: 4px;
    }
    .temp_container .temp {
      font-weight: 600;
      color: var(--orange-color);
      font-size: 1.4rem;
    }
    .loader-spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--orange-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    /* --- Context Menu Styles --- */
    #context-menu {
      position: absolute;
      background-color: #1e1e2e;
      border: 1px solid #313244;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(137, 180, 250, 0.1);
      z-index: 1000;
      display: none;
      min-width: 200px;
      transition: opacity 0.2s ease, transform 0.2s ease;
      opacity: 0;
      transform: translateY(10px);
    }
    #context-menu.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    .context-item {
      padding: 8px 16px;
      cursor: pointer;
      color: #cdd6f4;
      transition: background-color 0.2s ease;
    }
    .context-item:hover {
      background-color: #313244;
    }
    .context-separator {
      height: 1px;
      background-color: #313244;
      margin: 4px 0;
    }
    
    .theme-swatch {
      background-size: cover;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .theme-swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 0 8px 2px rgba(137, 180, 250, 0.5);
    }

    /* --- Enhanced Animations --- */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    /* --- Error States --- */
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #f38ba8;
      text-align: center;
    }
    
    .error-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.8;
    }
    
    /* --- Success States --- */
    .success-message {
      background-color: #a6e3a1;
      color: #181825;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 8px 0;
      opacity: 0;
      transform: translateY(-10px);
      animation: successFade 3s ease-out forwards;
    }
    
    @keyframes successFade {
      0% { opacity: 0; transform: translateY(-10px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
    
    /* --- Notification Styles --- */
    #notifications {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
    }
    .notification {
      background-color: #1e1e2e;
      border: 1px solid #313244;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(137, 180, 250, 0.1);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      color: #cdd6f4;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .notification.error {
      border-color: #f38ba8;
      color: #f38ba8;
    }
    .notification.success {
      border-color: #a6e3a1;
      color: #a6e3a1;
    }
    .notification svg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body onload="brython({debug: 0, cache: 'local'})">
  <main id="desktop" class="relative w-screen h-screen">
    <!-- DESKTOP SEARCH BAR -->
    <div id="desktop-search-container" class="absolute top-10 left-1/2 transform -translate-x-1/2 w-full max-w-lg p-4">
      <input type="text" id="desktop-search-input" class="w-full rounded-xl px-4 py-3 text-lg dark-input border-2 border-[#313244] focus:border-[#89b4fa] transition" placeholder="Search wikipedia">
    </div>
    
    <!-- USER INFO BAR -->
    <div id="user-info-bar" class="absolute top-0 left-0 right-0 bg-[#181825] border-b border-[#313244] px-4 py-2 flex items-center justify-between text-sm z-50 hidden">
      <div>
        <span class="text-gray-400">Logged in as:</span>
        <span id="current-username" class="font-medium text-[#89b4fa] ml-2"></span>
      </div>
      <button id="logout-btn" class="text-xs text-[#f38ba8] hover:text-[#eba0ac] underline">Logout</button>
    </div>
    
    <!-- WELCOME MODAL -->
    <div id="welcome-modal-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden" style="z-index: 100;">
      <div id="welcome-modal" class="bg-[#1e1e2e] p-8 rounded-xl max-w-lg w-[90%] border border-[#313244] shadow-2xl fade-in">
        <h2 class="text-3xl font-bold text-[#89b4fa] mb-4">Welcome to ScriptOS!</h2>
        <p class="text-gray-300 mb-6">This is your personal, unified desktop environment inspired by XeroLinux. Access tools like Wiki Browser, Chat, Weather, Camera, Games, and more from the dock below.</p>
        <p class="text-gray-300 mb-6">Use the search bar to find info, or open Settings to customize. Hold Shift to open multiple app instances!</p>
        <button id="welcome-close-btn" class="w-full dark-button-green py-2 rounded-lg font-semibold text-[#181825] transition hover:opacity-90">Get Started</button>
      </div>
    </div>
    
    <!-- Context Menu -->
    <div id="context-menu">
      <!-- Dynamic items will be added here -->
    </div>
    
    <!-- Notifications -->
    <div id="notifications"></div>
  </main>
  
  <footer class="absolute bottom-4 left-1/2 -translate-x-1/2">
    <div class="dock-container p-2 rounded-2xl shadow-lg space-x-2">
      <div id="icon-wikibrowser" class="dock-icon p-3 rounded-xl" title="Wiki Browser">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9 3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-chat" class="dock-icon p-3 rounded-xl" title="Chat">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-weather" class="dock-icon p-3 rounded-xl" title="Weather">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <!-- NEW CAMERA ICON -->
      <div id="icon-camera" class="dock-icon p-3 rounded-xl" title="Camera">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-games" class="dock-icon p-3 rounded-xl" title="Games">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 10C3.34315 10 2 11.3431 2 13V15C2 16.6569 3.34315 18 5 18H19C20.6569 18 22 16.6569 22 15V13C22 11.3431 20.6569 10 19 10H14.5" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 10C5 8.34315 6.34315 7 8 7H9.5" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.5 10C14.5 8.34315 15.8431 7 17.5 7H19" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 13V15M5 14H7" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M16 13H16.01M18 15H18.01" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-draw" class="dock-icon p-3 rounded-xl" title="Draw">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" viewBox="0 0 20 20" fill="currentColor">
          <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-editor" class="dock-icon p-3 rounded-xl" title="Code Editor">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-notepad" class="dock-icon p-3 rounded-xl" title="Notepad">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-calculator" class="dock-icon p-3 rounded-xl" title="Calculator">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-2 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="icon-settings" class="dock-icon p-3 rounded-xl" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[#89b4fa]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.573-1.066z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <div class="active-dot"></div>
      </div>
      
      <div id="dock-clock"></div>
      <div id="dock-battery">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <span id="battery-level">N/A</span>
      </div>
    </div>
  </footer>

  <script>
    // Enhanced error handling
    window.addEventListener('error', (e) => {
      console.error('ScriptOS Error:', e.error);
      showNotification('Error: ' + e.message, 'error');
    });

    // Utility functions
    const Utils = {
      debounce: (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      throttle: (func, limit) => {
        let inThrottle;
        return function() {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        }
      },
      
      validateUrl: (url) => {
        try {
          new URL(url);
          return url.startsWith('http://') || url.startsWith('https://');
        } catch {
          return false;
        }
      },
      
      showSuccessMessage: (message, parent = document.body) => {
        const msgEl = document.createElement('div');
        msgEl.className = 'success-message';
        msgEl.textContent = message;
        parent.appendChild(msgEl);
        setTimeout(() => msgEl.remove(), 3000);
      },
      
      showErrorState: (container, message, icon = 'error') => {
        const iconSvg = icon === 'error' 
          ? `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.268 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>`
          : `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
        
        container.innerHTML = `
          <div class="error-state">
            ${iconSvg}
            <p>${message}</p>
          </div>
        `;
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const desktop = document.getElementById('desktop');
      let highestZIndex = 50;
      let openWindows = {};
      let appInstanceCounters = {};
      let pendingWikiSearch = null;
      
      let activeInteraction = {
        type: null,
        element: null,
        offsetX: 0,
        offsetY: 0,
        direction: '',
        initX: 0, initY: 0,
        initW: 0, initH: 0,
        initLeft: 0, initTop: 0
      };
      
      const minWidth = 320;
      const minHeight = 250;
      
      function createWindowFrame(instanceId, title) {
        const newWindow = document.createElement('div');
        newWindow.className = "app-window absolute top-10 left-10 w-1/2 h-3/4 rounded-lg";
        newWindow.id = `window-${instanceId}`;
        newWindow.style.left = `${Math.floor(Math.random() * 20) + 10}%`;
        newWindow.style.top = `${Math.floor(Math.random() * 20) + 10}%`;
        newWindow.innerHTML = `
          <div class="window-header h-10 flex items-center justify-between px-3 rounded-t-lg">
            <span class="window-title font-semibold">${title}</span>
            <div class="flex items-center space-x-2">
              <button class="window-minimize w-4 h-4 bg-yellow-400 rounded-full hover:bg-yellow-500 focus:outline-none transition-colors" title="Minimize"></button>
              <button class="window-maximize w-4 h-4 bg-green-400 rounded-full hover:bg-green-500 focus:outline-none transition-colors" title="Maximize"></button>
              <button class="window-close w-4 h-4 bg-red-400 rounded-full hover:bg-red-500 focus:outline-none transition-colors" title="Close"></button>
            </div>
          </div>
        `;
       
        const resizers = `
          <div class="resizer top-left" data-direction="top-left"></div>
          <div class="resizer top" data-direction="top"></div>
          <div class="resizer top-right" data-direction="top-right"></div>
          <div class="resizer left" data-direction="left"></div>
          <div class="resizer right" data-direction="right"></div>
          <div class="resizer bottom-left" data-direction="bottom-left"></div>
          <div class="resizer bottom" data-direction="bottom"></div>
          <div class="resizer bottom-right" data-direction="bottom-right"></div>
        `;
        newWindow.innerHTML += resizers;
       
        return newWindow;
      }
      
      function handleAppClick(event, appId, title, contentHtml, onOpenCallback = null) {
        showNotification(`Loading ${title}...`, 'success');
        if (event && event.shiftKey) {
          createNewAppInstance(appId, title, contentHtml, onOpenCallback);
          return;
        }
        
        const instances = Object.entries(openWindows).filter(([id, data]) => data.appId === appId);
        
        const minimizedInstances = instances.filter(([id, data]) => data.minimized);
        if (minimizedInstances.length > 0) {
          const [instanceIdToRestore, dataToRestore] = minimizedInstances[0];
          
          dataToRestore.el.style.display = 'flex';
          dataToRestore.minimized = false;
          focusWindow(dataToRestore.el);
          return;
        }
        
        const openInstances = instances.filter(([id, data]) => !data.minimized);
        if (openInstances.length > 0) {
          const topInstanceData = openInstances
            .map(([id, data]) => data)
            .sort((a, b) => b.el.style.zIndex - a.el.style.zIndex)[0];
            
          focusWindow(topInstanceData.el);
          return;
        }
        
        createNewAppInstance(appId, title, contentHtml, onOpenCallback);
      }
      
      function createNewAppInstance(appId, title, contentHtml, onOpenCallback = null) {
        appInstanceCounters[appId] = (appInstanceCounters[appId] || 0) + 1;
        const instanceId = `${appId}-${appInstanceCounters[appId]}`;
        
        const dockIconDot = document.querySelector(`#icon-${appId} .active-dot`);
        const newWindow = createWindowFrame(instanceId, title);
        
        if (appId === 'draw') {
          newWindow.innerHTML += `
            <div id="draw-toolbar" class="p-2 flex items-center gap-4 flex-shrink-0">
              ${contentHtml}
            </div>
            <div class="window-content flex-grow p-0">
              <canvas id="draw-canvas"></canvas>
            </div>
          `;
        } else {
          const contentArea = document.createElement('div');
          contentArea.className = "window-content flex-grow p-0";
          contentArea.innerHTML = contentHtml;
          newWindow.appendChild(contentArea);
        }
       
        newWindow.style.display = 'flex';
        desktop.appendChild(newWindow);
        setTimeout(() => newWindow.classList.add('active'), 10);
        
        openWindows[instanceId] = { el: newWindow, minimized: false, appId: appId };
        
        if (dockIconDot) dockIconDot.style.display = 'block';
        
        setupWindow(newWindow, instanceId, appId);
        focusWindow(newWindow);
        
        if (onOpenCallback) {
          try {
            onOpenCallback(newWindow, instanceId);
            showNotification(`${title} loaded successfully!`, 'success');
          } catch (error) {
            console.error(`Error in app callback for ${appId}:`, error);
            Utils.showErrorState(newWindow.querySelector('.window-content'), 
              'App failed to initialize properly');
            showNotification(`Error loading ${title}: ${error.message}`, 'error');
          }
        }
        
        return newWindow;
      }
      
      function setupWindow(windowEl, instanceId, appId) {
        const header = windowEl.querySelector('.window-header');
       
        header.addEventListener('mousedown', (e) => {
          if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
         
          activeInteraction = {
            type: 'drag',
            element: windowEl,
            offsetX: e.clientX - windowEl.offsetLeft,
            offsetY: e.clientY - windowEl.offsetTop
          };
         
          focusWindow(windowEl);
          e.preventDefault();
        });
       
        windowEl.querySelectorAll('.resizer').forEach(resizer => {
          resizer.addEventListener('mousedown', (e) => {
            activeInteraction = {
              type: 'resize',
              element: windowEl,
              direction: resizer.dataset.direction,
              initX: e.clientX,
              initY: e.clientY,
              initW: windowEl.offsetWidth,
              initH: windowEl.offsetHeight,
              initLeft: windowEl.offsetLeft,
              initTop: windowEl.offsetTop
            };
           
            focusWindow(windowEl);
            e.preventDefault();
            e.stopPropagation();
          });
        });
        
        windowEl.querySelector('.window-close').addEventListener('click', () => closeApp(instanceId));
        windowEl.querySelector('.window-minimize').addEventListener('click', () => {
          windowEl.style.display = 'none';
          openWindows[instanceId].minimized = true;
        });
        
        let isMaximized = false, oldPos = {};
        windowEl.querySelector('.window-maximize').addEventListener('click', () => {
          if (isMaximized) {
            Object.assign(windowEl.style, oldPos);
            windowEl.querySelectorAll('.resizer').forEach(r => r.style.display = 'block');
            isMaximized = false;
          } else {
            oldPos = { 
              left: windowEl.style.left, 
              top: windowEl.style.top, 
              width: windowEl.style.width, 
              height: windowEl.style.height 
            };
            Object.assign(windowEl.style, { left: '0', top: '0', width: '100%', height: '100%' });
            windowEl.querySelectorAll('.resizer').forEach(r => r.style.display = 'none');
            isMaximized = true;
          }
        });
        
        windowEl.addEventListener('mousedown', () => focusWindow(windowEl));
      }
      
      function focusWindow(windowEl) {
        highestZIndex++;
        windowEl.style.zIndex = highestZIndex;
      }
     
      function closeApp(instanceId) {
        const app = openWindows[instanceId];
        if (!app) return;
        
        const appIdentifier = app.appId;
       
        // Enhanced cleanup
        if (appIdentifier === 'draw' && app.resizeObserver) {
          app.resizeObserver.disconnect();
        }
        if (appIdentifier === 'games' && app.onKeydownListener) {
          document.removeEventListener('keydown', app.onKeydownListener);
        }
        if (appIdentifier === 'chat' && app.chatInterval) {
          clearInterval(app.chatInterval);
        }
        if (appIdentifier === 'chat' && app.userListInterval) {
          clearInterval(app.userListInterval);
        }
        if (appIdentifier === 'camera') {
          // Stop camera stream
          if (app.mediaStream) {
            app.mediaStream.getTracks().forEach(track => track.stop());
          }
        }
        
        if (app.el && app.el.parentNode === desktop) {
          desktop.removeChild(app.el);
        }
        
        delete openWindows[instanceId];
        
        const remainingInstances = Object.values(openWindows).some(win => win.appId === appIdentifier);
        
        if (!remainingInstances) {
          const dockIconDot = document.querySelector(`#icon-${appIdentifier} .active-dot`);
          if (dockIconDot) {
            dockIconDot.style.display = 'none';
          }
        }
      }
     
      // Enhanced global event handlers with throttling
      document.addEventListener('mousemove', Utils.throttle((e) => {
        if (!activeInteraction.type) return;
       
        const el = activeInteraction.element;
       
        if (activeInteraction.type === 'drag') {
          let newX = e.clientX - activeInteraction.offsetX;
          let newY = e.clientY - activeInteraction.offsetY;
         
          const visibleMargin = 40;
          newX = Math.max(-el.offsetWidth + visibleMargin, newX);
          newX = Math.min(newX, desktop.clientWidth - visibleMargin);
          newY = Math.max(0, newY);
          newY = Math.min(newY, desktop.clientHeight - visibleMargin);
         
          el.style.left = `${newX}px`;
          el.style.top = `${newY}px`;
         
        } else if (activeInteraction.type === 'resize') {
          const { initX, initY, initW, initH, initLeft, initTop, direction } = activeInteraction;
          let newWidth = initW, newHeight = initH, newLeft = initLeft, newTop = initTop;
         
          const deltaX = e.clientX - initX;
          const deltaY = e.clientY - initY;
          
          if (direction.includes('right')) {
            newWidth = Math.max(minWidth, initW + deltaX);
          }
          if (direction.includes('bottom')) {
            newHeight = Math.max(minHeight, initH + deltaY);
          }
          if (direction.includes('left')) {
            let potentialWidth = initW - deltaX;
            if (potentialWidth >= minWidth) {
              newWidth = potentialWidth;
              newLeft = initLeft + deltaX;
            } else {
              newWidth = minWidth;
              newLeft = initLeft + (initW - minWidth);
            }
          }
          if (direction.includes('top')) {
            let potentialHeight = initH - deltaY;
            if (potentialHeight >= minHeight) {
              newHeight = potentialHeight;
              newTop = initTop + deltaY;
            } else {
              newHeight = minHeight;
              newTop = initTop + (initH - minHeight);
            }
          }
         
          el.style.width = `${newWidth}px`;
          el.style.height = `${newHeight}px`;
          el.style.left = `${newLeft}px`;
          el.style.top = `${newTop}px`;
        }
      }, 16));
     
      document.addEventListener('mouseup', () => {
        activeInteraction.type = null;
        activeInteraction.element = null;
      });
      
      // Enhanced desktop search with debouncing
      document.getElementById('desktop-search-input').addEventListener('keydown', Utils.debounce((e) => {
        if (e.key !== 'Enter') return;
        
        const term = e.target.value.trim();
        if (!term) return;
        
        e.target.value = '';
        
        const instances = Object.entries(openWindows).filter(([id, data]) => data.appId === 'wikibrowser');
        let targetWindow = null;
        
        if (instances.length > 0) {
          const openInstances = instances.filter(([id, data]) => !data.minimized);
          if (openInstances.length > 0) {
            targetWindow = openInstances.sort((a, b) => b[1].el.style.zIndex - a[1].el.style.zIndex)[0][1].el;
            focusWindow(targetWindow);
          } else {
            const [instanceId, data] = instances[0];
            targetWindow = data.el;
            openWindows[instanceId].minimized = false;
            targetWindow.style.display = 'flex';
            focusWindow(targetWindow);
          }
        }
        
        if (targetWindow) {
          const searchInput = targetWindow.querySelector('#wikibrowser-search');
          const goBtn = targetWindow.querySelector('#wikibrowser-go');
          if (searchInput && goBtn) {
            searchInput.value = term;
            goBtn.click();
          }
        } else {
          pendingWikiSearch = term;
          document.getElementById('icon-wikibrowser').click();
        }
      }, 300));

      // --- App Definitions ---

// 1. Wiki Browser App (FIXED for Google Apps Script Routing)
      document.getElementById('icon-wikibrowser').addEventListener('click', (e) => {
        const content = `
          <div class="flex flex-col h-full">
            <div id="wikibrowser-content-wrapper" class="flex-grow overflow-hidden relative">
              <!-- Loader is absolutely positioned and centered -->
              <div id="wikibrowser-loader" class="loader" style="display:block; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
              <!-- iframe uses srcdoc for direct HTML content -->
              <iframe id="wikibrowser-frame" class="w-full h-full border-0 hidden" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"></iframe>
            </div>
          </div>
        `;
        
        handleAppClick(e, 'wikibrowser', 'Browser', content, (windowEl) => {
          const iframe = windowEl.querySelector('#wikibrowser-frame');
          const loader = windowEl.querySelector('#wikibrowser-loader');

          // Load the 'prxy' HTML content directly using getGameContent logic
          google.script.run
            .withSuccessHandler(htmlContent => {
              // Hide loader when iframe finishes rendering
              iframe.onload = () => {
                loader.style.display = 'none';
                iframe.classList.remove('hidden');
              };

              // Inject the retrieved HTML into the iframe
              iframe.srcdoc = htmlContent;
            })
            .withFailureHandler(err => {
              Utils.showErrorState(windowEl, "Could not load prxy.html: " + err.message);
              loader.style.display = 'none';
            })
            .getGameContent('prxy'); // Requesting 'prxy' file specifically
        });
      });

      // 2. NEW Camera App
      document.getElementById('icon-camera').addEventListener('click', (e) => {
        const content = `
          <div class="flex flex-col h-full">
            <div class="flex-grow relative bg-black">
              <video id="camera-video" autoplay muted></video>
              <canvas id="camera-canvas"></canvas>
              <div id="camera-error" class="camera-error hidden">
                <div>
                  <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"/>
                  </svg>
                  <h3 class="text-lg font-semibold mb-2">Camera Access Denied</h3>
                  <p class="text-sm mb-4">Please allow camera access to use this feature.</p>
                  <button id="camera-retry" class="dark-button-green px-4 py-2 rounded">Try Again</button>
                </div>
              </div>
            </div>
            
            <div class="camera-photos hidden" id="camera-photos-bar">
              <!-- Photos will be added here -->
            </div>
            
            <div class="camera-controls">
              <button id="camera-toggle" class="camera-button camera-toggle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4"/>
                </svg>
                Start Camera
              </button>
              
              <button id="camera-capture" class="camera-button camera-capture" disabled>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Capture
              </button>
              
              <button id="camera-clear" class="camera-button camera-toggle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Clear All
              </button>
            </div>
          </div>
        `;
        
        handleAppClick(e, 'camera', 'Camera', content, (windowEl, instanceId) => {
          const video = windowEl.querySelector('#camera-video');
          const canvas = windowEl.querySelector('#camera-canvas');
          const errorDiv = windowEl.querySelector('#camera-error');
          const toggleBtn = windowEl.querySelector('#camera-toggle');
          const captureBtn = windowEl.querySelector('#camera-capture');
          const clearBtn = windowEl.querySelector('#camera-clear');
          const retryBtn = windowEl.querySelector('#camera-retry');
          const photosBar = windowEl.querySelector('#camera-photos-bar');
          
          let mediaStream = null;
          let isStreaming = false;
          let photos = JSON.parse(localStorage.getItem('scriptos_camera_photos') || '[]');
          
          function updatePhotosBar() {
            if (photos.length > 0) {
              photosBar.classList.remove('hidden');
              photosBar.innerHTML = photos.map((photo, index) => 
                `<img src="${photo}" class="camera-photo" data-index="${index}" alt="Photo ${index + 1}">`
              ).join('');
              
              // Add click listeners for photo viewing
              photosBar.querySelectorAll('.camera-photo').forEach(img => {
                img.addEventListener('click', () => {
                  // Open photo in new window or modal
                  window.open(img.src, '_blank');
                });
              });
            } else {
              photosBar.classList.add('hidden');
            }
          }
          
          async function startCamera() {
            try {
              mediaStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                  width: { ideal: 1280 }, 
                  height: { ideal: 720 },
                  facingMode: 'user' 
                } 
              });
              
              video.srcObject = mediaStream;
              video.classList.remove('hidden');
              errorDiv.classList.add('hidden');
              
              toggleBtn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9l6 6m0-6l-6 6"/>
                </svg>
                Stop Camera
              `;
              
              captureBtn.disabled = false;
              isStreaming = true;
              
              // Store stream reference for cleanup
              if (openWindows[instanceId]) {
                openWindows[instanceId].mediaStream = mediaStream;
              }
              
              Utils.showSuccessMessage('Camera started successfully', windowEl.querySelector('.window-content'));
              
            } catch (error) {
              console.error('Camera error:', error);
              showCameraError(error.message);
            }
          }
          
          function stopCamera() {
            if (mediaStream) {
              mediaStream.getTracks().forEach(track => track.stop());
              mediaStream = null;
            }
            
            video.srcObject = null;
            toggleBtn.innerHTML = `
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              Start Camera
            `;
            
            captureBtn.disabled = true;
            isStreaming = false;
          }
          
          function showCameraError(message) {
            video.classList.add('hidden');
            errorDiv.classList.remove('hidden');
            errorDiv.querySelector('p').textContent = message || 'Camera access denied or not available.';
          }
          
          function capturePhoto() {
            if (!isStreaming) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            const dataURL = canvas.toDataURL('image/png');
            photos.unshift(dataURL); // Add to beginning
            
            // Limit to 10 photos
            if (photos.length > 10) {
              photos = photos.slice(0, 10);
            }
            
            localStorage.setItem('scriptos_camera_photos', JSON.stringify(photos));
            updatePhotosBar();
            
            // Visual feedback
            video.style.filter = 'brightness(1.5)';
            setTimeout(() => {
              video.style.filter = 'brightness(1)';
            }, 150);
            
            Utils.showSuccessMessage('Photo captured!', windowEl.querySelector('.window-content'));
          }
          
          function clearAllPhotos() {
            if (photos.length === 0) return;
            
            if (confirm('Delete all photos? This cannot be undone.')) {
              photos = [];
              localStorage.removeItem('scriptos_camera_photos');
              updatePhotosBar();
              Utils.showSuccessMessage('All photos deleted', windowEl.querySelector('.window-content'));
            }
          }
          
          // Event listeners
          toggleBtn.addEventListener('click', () => {
            if (isStreaming) {
              stopCamera();
            } else {
              startCamera();
            }
          });
          
          captureBtn.addEventListener('click', capturePhoto);
          clearBtn.addEventListener('click', clearAllPhotos);
          retryBtn.addEventListener('click', startCamera);
          
          // Keyboard shortcuts
          windowEl.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && isStreaming) {
              e.preventDefault();
              capturePhoto();
            }
          });
          
          // Initialize
          updatePhotosBar();
          
          // Auto-start camera (optional)
          // startCamera();
        });
      });

      // 3. Enhanced Chat App (with better error handling)
      document.getElementById('icon-chat').addEventListener('click', (e) => {
        const content = `
          <style>
            .chat-container ::-webkit-scrollbar {
              width: 8px;
            }
            .chat-container ::-webkit-scrollbar-track {
              background: #181825;
            }
            .chat-container ::-webkit-scrollbar-thumb {
              background: #313244;
              border-radius: 4px;
            }
            .chat-container ::-webkit-scrollbar-thumb:hover {
              background: #45475a;
            }

            .loader {
              width: 32px;
              height: 32px;
              border: 4px solid #313244;
              border-bottom-color: #89b4fa;
              border-radius: 50%;
              display: inline-block;
              box-sizing: border-box;
              animation: rotation 1s linear infinite;
              margin: 20px auto;
              position: relative;
            }
            @keyframes rotation {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            
            .dark-input {
              background-color: #181825;
              border: 1px solid #313244;
              color: #cdd6f4;
            }
            .dark-input:focus {
              outline: none;
              border-color: #89b4fa;
              box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.4);
            }
            
            .user-list-item {
              display: flex;
              align-items: center;
              gap: 8px;
              padding: 8px 12px;
              cursor: pointer;
              border-radius: 6px;
              margin: 2px 4px;
            }
            .user-list-item:hover {
              background-color: #1e1e2e;
            }
            .user-list-item.active {
              background-color: #89b4fa;
              color: #181825 !important;
            }
            .user-list-item.active .font-bold {
              color: #181825 !important;
            }
            .user-list-item .status-dot {
              width: 10px;
              height: 10px;
              border-radius: 50%;
              flex-shrink: 0;
            }
            .user-list-item .status-online { background-color: #a6e3a1; }
            .user-list-item .status-offline { background-color: #6c7086; }

            .message-wrapper {
              display: flex;
              align-items: flex-start;
              gap: 10px;
              margin-bottom: 12px;
              max-width: 90%;
            }
            .message-wrapper.self {
              margin-left: auto;
              flex-direction: row-reverse;
            }
            .message-wrapper.other {
              margin-right: auto;
            }
            .chat-avatar {
              width: 40px;
              height: 40px;
              border-radius: 50%;
              flex-shrink: 0;
              margin-top: 4px;
              background-color: #313244;
              object-fit: cover;
            }
            .chat-message {
              padding: 10px 14px;
              border-radius: 18px;
              max-width: 100%;
              width: fit-content;
              text-wrap: wrap;
              word-break: break-word;
            }
            .chat-message p {
              margin: 0;
              color: #cdd6f4;
            }
            .chat-message .sent-image {
              max-width: 250px;
              max-height: 250px;
              object-fit: cover;
              border-radius: 12px;
              margin-bottom: 5px;
              cursor: pointer;
            }
            
            .self-message {
              background-color: #89b4fa;
              border-radius: 18px 18px 4px 18px;
              margin-left: 0;
            }
            .self-message p, .self-message .timestamp {
              color: #181825;
            }
            
            .other-message {
              background-color: #1e1e2e;
              border-radius: 18px 18px 18px 4px;
              margin-right: 0;
            }
            
            .chat-message .username {
              display: block;
              font-weight: 600;
              font-size: 0.8rem;
              margin-bottom: 4px;
              color: #a6adc8;
            }
            
            .self-message .username {
              color: #181825;
            }
            .other-message .username {
              color: #89b4fa;
            }

            .chat-message .timestamp {
              display: block;
              font-size: 0.7rem;
              text-align: right;
              margin-top: 4px;
              color: #6c7086;
            }
            .self-message .timestamp {
              color: #313244;
            }

            .chat-message.admin {
              border: 2px solid #cba6f7;
              box-shadow: 0 0 8px rgba(203, 166, 247, 0.5);
            }
            .chat-message.admin .username {
              color: #cba6f7;
            }

            .chat-message.moderator {
              border: 2px solid #f9e2af;
              box-shadow: 0 0 8px rgba(249, 226, 175, 0.5);
            }
            .chat-message.moderator .username {
              color: #f9e2af;
            }

            .chat-message.canceled {
              border: 2px solid #f38ba8;
              opacity: 0.8;
            }
            .chat-message.canceled .username {
              color: #f38ba8;
              text-decoration: line-through;
            }
            .chat-message.canceled p {
              color: #a6adc8;
              font-style: italic;
            }
            
            .chat-message.contributor {
              border: 2px solid #a6e3a1;
              box-shadow: 0 0 8px rgba(166, 227, 161, 0.5);
            }
            .chat-message.contributor .username {
              color: #a6e3a1;
            }
            
            .empty-chat-placeholder {
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: #6c7086;
              font-style: italic;
            }
          </style>

          <div id="chat-image-url-modal-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden" style="z-index: 100;">
            <div id="image-url-modal" class="bg-[#1e1e2e] p-6 rounded-xl max-w-md w-[90%] border border-[#313244] shadow-2xl fade-in">
              <h2 class="text-2xl font-bold text-[#89b4fa] mb-4">Enter Image URL</h2>
              <p class="text-gray-300 mb-4">Please paste a direct URL (starting with http:// or https://) to an image.</p>
              <input type="text" id="chat-image-url-input" class="w-full rounded-lg px-3 py-2 text-sm dark-input" placeholder="https://...">
              <p id="chat-image-url-error" class="text-[#f38ba8] text-sm mt-2 hidden"></p>
              <div class="flex justify-end gap-4 mt-6">
                <button id="chat-image-url-cancel" class="dark-button-gray px-4 py-2 rounded-lg text-sm font-semibold">Cancel</button>
                <button id="chat-image-url-submit" class="dark-button-green px-4 py-2 rounded-lg text-sm font-semibold">Submit</button>
              </div>
            </div>
          </div>

          <div class="flex flex-row h-full bg-[#181825] text-[#cdd6f4] chat-container">
            <div class="chat-sidebar flex flex-col w-60 border-r border-[#313244] flex-shrink-0 bg-[#1e1e2e]" style="flex-basis: 240px;">
              <div class="p-2 border-b border-[#313244]">
                <input id="chat-user-search" type="text" class="w-full rounded px-2 py-1 text-sm dark-input" placeholder="Search users...">
              </div>
              <div id="chat-user-list" class="flex-grow overflow-auto p-1">
                <div class="loader"></div>
              </div>
            </div>

            <div class="chat-v-resizer" id="chat-v-resizer"></div>
           
            <div class="chat-main flex flex-col flex-grow">
              <div class="flex items-center p-2 border-b border-[#313244] flex-shrink-0 bg-[#1e1e2e]">
                <label for="chat-username" class="text-sm font-medium text-gray-300 mr-2">Name:</label>
                <input id="chat-username" type="text" class="flex-grow rounded px-2 py-1 text-sm dark-input" placeholder="Loading...">
              </div>
             
              <div id="chat-header" class="p-3 border-b border-[#313244] flex-shrink-0 bg-[#1e1e2e]">
                <h3 class="text-white font-bold text-lg">Global Chat</h3>
              </div>
             
              <div id="chat-messages" class="flex-grow p-4 overflow-auto" style="flex-basis: 400px;">
                <div class="loader"></div>
              </div>

              <div class="chat-h-resizer" id="chat-h-resizer"></div>

              <div id="chat-image-preview-container" class="p-2 border-t border-[#313244] hidden items-center gap-2 bg-[#181825]">
                <img id="chat-image-preview" src="" class="h-16 w-16 object-cover rounded">
                <div class="flex-grow min-w-0">
                  <p class="text-xs text-gray-400">Image Preview:</p>
                  <p id="chat-image-preview-url" class="text-xs text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap"></p>
                </div>
                <button id="chat-image-preview-remove" class="text-[#f38ba8] hover:text-[#eba0ac] text-xs p-1" title="Remove Image">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </div>
             
              <div class="flex items-center p-2 border-t border-[#313244] flex-shrink-0 gap-2">
                <button id="chat-send-image" class="dark-button-gray p-2 rounded-lg flex-shrink-0" title="Send Image URL">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </button>
                <input id="chat-input" type="text" class="flex-grow rounded-lg px-3 py-2 text-sm dark-input" placeholder="Type a message...">
                <span id="chat-word-count" class="text-xs text-gray-500 mr-2 flex-shrink-0">0 words</span>
                <button id="chat-send" class="dark-button-green px-4 py-2 rounded-lg text-sm font-semibold flex-shrink-0">Send</button>
              </div>
            </div>
          </div>
        `;
       
        handleAppClick(e, 'chat', 'Global Chat', content, (windowEl, instanceId) => {
          const usernameInput = windowEl.querySelector('#chat-username');
          const messagesEl = windowEl.querySelector('#chat-messages');
          const inputEl = windowEl.querySelector('#chat-input');
          const sendBtn = windowEl.querySelector('#chat-send');
          const sendImageBtn = windowEl.querySelector('#chat-send-image');
         
          const userSearchInput = windowEl.querySelector('#chat-user-search');
          const userListEl = windowEl.querySelector('#chat-user-list');
          const chatHeader = windowEl.querySelector('#chat-header');
          const wordCountEl = windowEl.querySelector('#chat-word-count');
          const previewContainer = windowEl.querySelector('#chat-image-preview-container');
          const previewImg = windowEl.querySelector('#chat-image-preview');
          const previewUrl = windowEl.querySelector('#chat-image-preview-url');
          const previewRemoveBtn = windowEl.querySelector('#chat-image-preview-remove');
          const vResizer = windowEl.querySelector('#chat-v-resizer');
          const hResizer = windowEl.querySelector('#chat-h-resizer');
          const sidebar = windowEl.querySelector('.chat-sidebar');
         
          const imageUrlModalOverlay = windowEl.querySelector('#chat-image-url-modal-overlay');
          const imageUrlInput = windowEl.querySelector('#chat-image-url-input');
          const imageUrlError = windowEl.querySelector('#chat-image-url-error');
          const imageUrlCancel = windowEl.querySelector('#chat-image-url-cancel');
          const imageUrlSubmit = windowEl.querySelector('#chat-image-url-submit');

          let currentChat = { type: 'global' };
          let selfEmail = '';
          let allUsers = [];
          let pendingImageUrl = null;
          let isVResizing = false;
          let isHResizing = false;

          // Enhanced resizer logic
          vResizer.addEventListener('mousedown', (e) => {
            isVResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
          });
          
          hResizer.addEventListener('mousedown', (e) => {
            isHResizing = true;
            document.body.style.cursor = 'row-resize';
            document.body.style.userSelect = 'none';
          });
          
          windowEl.addEventListener('mousemove', Utils.throttle((e) => {
            if (isVResizing) {
              const sidebarRect = sidebar.getBoundingClientRect();
              const newWidth = e.clientX - sidebarRect.left;
              if (newWidth > 150 && newWidth < 400) {
                sidebar.style.flexBasis = `${newWidth}px`;
              }
            } else if (isHResizing) {
              const messagesRect = messagesEl.getBoundingClientRect();
              const newHeight = e.clientY - messagesRect.top;
              if (newHeight > 100 && newHeight < (windowEl.clientHeight - 200)) {
                messagesEl.style.flexBasis = `${newHeight}px`;
              }
            }
          }, 16));
          
          windowEl.addEventListener('mouseup', () => {
            isVResizing = false;
            isHResizing = false;
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
          });

          // Enhanced word count with throttling
          inputEl.addEventListener('input', Utils.throttle(() => {
            const wordCount = inputEl.value.trim().split(/\s+/).filter(word => word.length > 0).length;
            wordCountEl.textContent = `${wordCount} word${wordCount !== 1 ? 's' : ''}`;
          }, 100));

          // Load username with better error handling
          google.script.run
            .withSuccessHandler(serverUsername => {
              const finalUsername = serverUsername.trim() || '';
              usernameInput.value = finalUsername;
              if (finalUsername) {
                usernameInput.disabled = true;
                localStorage.setItem('scriptos_chat_username', finalUsername);
                fetchUserList();
                const userListInterval = setInterval(fetchUserList, 30000);
                if (openWindows[instanceId]) {
                  openWindows[instanceId].userListInterval = userListInterval;
                }
              } else {
                usernameInput.placeholder = "Enter your name...";
                usernameInput.value = localStorage.getItem('scriptos_chat_username') || '';
              }
            })
            .withFailureHandler((error) => {
              console.error('Failed to get username:', error);
              usernameInput.value = localStorage.getItem('scriptos_chat_username') || '';
              usernameInput.placeholder = "Enter your name...";
              Utils.showErrorState(userListEl, 'Failed to connect to chat server');
            })
            .getCurrentUsername();

          google.script.run
            .withSuccessHandler(email => {
              selfEmail = email;
            })
            .withFailureHandler(() => {
              console.error('Failed to fetch current email');
            })
            .getCurrentEmail();

          function renderMessages(messages) {
            const isNearBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 150;
            const currentUsername = usernameInput.value.trim();
            messagesEl.innerHTML = '';
           
            if (Array.isArray(messages)) {
              if (messages.length === 0) {
                messagesEl.innerHTML = `<div class="empty-chat-placeholder fade-in">No messages yet. Be the first!</div>`;
                return;
              }
             
              messages.forEach(msg => {
                const wrapperEl = document.createElement('div');
                let isSelf = false;

                if (currentChat.type === 'global') {
                  isSelf = (selfEmail && msg.email) ? msg.email === selfEmail : (msg.user === currentUsername && currentUsername !== '');
                } else {
                  isSelf = msg.fromEmail === selfEmail;
                }
               
                wrapperEl.className = `message-wrapper ${isSelf ? 'self' : 'other'}`;

                const isModerator = currentChat.type === 'global' && msg.role === 'moderator';
                const isAdmin = currentChat.type === 'global' && msg.role === 'admin';
                const isCanceled = currentChat.type === 'global' && msg.role === 'canceled';
                const isContributor = currentChat.type === 'global' && msg.role === 'contributor';
                
                let finalAvatarUrl = msg.avatarUrl;
                if (isSelf && selfEmail) {
                  const myCustomAvatar = localStorage.getItem('scriptos_avatar_url_' + selfEmail);
                  if (myCustomAvatar) {
                    finalAvatarUrl = myCustomAvatar;
                  }
                }
                if (currentChat.type === 'dm' && msg.fromAvatarUrl) {
                  finalAvatarUrl = msg.fromAvatarUrl;
                }

                let contentHtml = '';
                let msgText = msg.text;
                
                const imageMatch = msg.text.match(/^(IMAGE_URL::(.*?))\n(.*)/s);
                
                if (imageMatch) {
                  const url = imageMatch[2];
                  msgText = imageMatch[3];
                  contentHtml += `<img src="${url}" class="sent-image" alt="User image" onerror="this.src='https://placehold.co/200x100/f38ba8/181825?text=Bad+Image+URL';">`;
                } else if (msg.text.startsWith('IMAGE_URL::')) {
                  const url = msg.text.substring(11);
                  contentHtml = `<img src="${url}" class="sent-image" alt="User image" onerror="this.src='https://placehold.co/200x100/f38ba8/181825?text=Bad+Image+URL';">`;
                  msgText = '';
                }
                
                if (msgText) {
                  contentHtml += `<p>${msgText}</p>`;
                }

                let userHtml = '';
                const usernameToShow = (currentChat.type === 'global') ? msg.user : msg.fromUsername;
                const userNameClasses = `username`;
               
                if (isAdmin) {
                  userHtml = `<span class="${userNameClasses}">${usernameToShow} (Owner)</span>`;
                } else if (isModerator) {
                  userHtml = `<span class="${userNameClasses}">${usernameToShow} (Moderator)</span>`;
                } else if (isCanceled) {
                  userHtml = `<span class="${userNameClasses}">${usernameToShow} (Canceled)</span>`;
                } else if (isContributor) {
                  userHtml = `<span class="${userNameClasses}">${usernameToShow} (Owners' friend )</span>`;
                } else {
                  userHtml = `<span class="${userNameClasses}">${usernameToShow}</span>`;
                }
                
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `chat-message ${isSelf ? 'self-message' : 'other-message'}`;
                
                if (isAdmin) bubbleEl.classList.add('admin');
                else if (isModerator) bubbleEl.classList.add('moderator');
                else if (isCanceled) bubbleEl.classList.add('canceled');
                else if (isContributor) bubbleEl.classList.add('contributor');
                
                bubbleEl.innerHTML = `
                  ${userHtml}
                  ${contentHtml}
                  <span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</span>
                `;
                
                const avatarEl = document.createElement('img');
                avatarEl.src = finalAvatarUrl || 'https://placehold.co/40x40/313244/cdd6f4?text=??';
                avatarEl.className = 'chat-avatar';
                avatarEl.onerror = () => { avatarEl.src = 'https://placehold.co/40x40/313244/cdd6f4?text=??' };
                
                if (isSelf) {
                  wrapperEl.appendChild(bubbleEl);
                  wrapperEl.appendChild(avatarEl);
                } else {
                  wrapperEl.appendChild(avatarEl);
                  wrapperEl.appendChild(bubbleEl);
                }
                
                messagesEl.appendChild(wrapperEl);
              });
             
              if (isNearBottom) {
                messagesEl.scrollTop = messagesEl.scrollHeight;
              }
             
            } else if (messages && messages.error) {
              Utils.showErrorState(messagesEl, `Error loading messages: ${messages.error}`);
            } else {
              Utils.showErrorState(messagesEl, 'Error: Received invalid message data.');
            }
          }

          function fetchCurrentMessages() {
            const handler = google.script.run
              .withSuccessHandler(jsonString => {
                try {
                  const messages = JSON.parse(jsonString);
                  renderMessages(messages);
                } catch (e) {
                  console.error("Failed to parse messages:", e);
                  Utils.showErrorState(messagesEl, "Failed to parse messages from server.");
                }
              })
              .withFailureHandler(error => {
                Utils.showErrorState(messagesEl, error.message);
              });
           
            if (currentChat.type === 'global') {
              handler.getMessages();
            } else {
              handler.getDirectMessages(currentChat.email);
            }
          }

          function sendMessage() {
            const username = usernameInput.value.trim();
            const text = inputEl.value.trim();
           
            // --- ADMIN COMMANDS / EASTER EGGS ---
            // These commands run locally and are not sent to the server
            if (text.startsWith('/')) {
              const cmd = text.toLowerCase().split(' ')[0];
              inputEl.value = ''; // Clear input immediately
              
              if (cmd === '/barrel') {
                document.body.style.transition = "transform 2s ease-in-out";
                document.body.style.transform = "rotate(360deg)";
                setTimeout(() => {
                   document.body.style.transition = "none";
                   document.body.style.transform = "none";
                }, 2000);
                Utils.showSuccessMessage(' Do a barrel roll!', messagesEl);
                return;
              }
              
              if (cmd === '/matrix') {
                const style = document.createElement('style');
                style.id = 'matrix-style';
                style.innerHTML = `
                  * { color: #00ff00 !important; background-color: #000000 !important; font-family: 'Courier New', monospace !important; border-color: #00ff00 !important; }
                  img { filter: grayscale(100%) sepia(100%) hue-rotate(50deg) saturate(500%); }
                  .app-window, .dock-container { background-color: #000 !important; border: 1px solid #0f0 !important; box-shadow: none !important; }
                `;
                document.head.appendChild(style);
                Utils.showSuccessMessage(' Matrix mode engaged. Type /reset to exit.', messagesEl);
                return;
              }

              if (cmd === '/invert') {
                 const current = document.body.style.filter;
                 document.body.style.filter = current.includes('invert') ? '' : 'invert(1)';
                 Utils.showSuccessMessage(' Reality inverted.', messagesEl);
                 return;
              }

              if (cmd === '/party') {
                 const style = document.createElement('style');
                 style.id = 'party-style';
                 style.innerHTML = `
                   @keyframes disco { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
                   body { animation: disco 2s linear infinite; }
                 `;
                 document.head.appendChild(style);
                 Utils.showSuccessMessage(' Party mode activated!', messagesEl);
                 return;
              }
              
              if (cmd === '/reset') {
                 document.body.style.transform = '';
                 document.body.style.filter = '';
                 document.body.style.animation = '';
                 ['matrix-style', 'party-style'].forEach(id => {
                   const el = document.getElementById(id);
                   if(el) el.remove();
                 });
                 Utils.showSuccessMessage(' System normalized.', messagesEl);
                 return;
              }
              
              // If command not found, let it fall through or show error
              Utils.showErrorState(messagesEl, `Unknown command: ${cmd}`);
              return;
            }
            // -------------------------------------

            if (!username) {
              Utils.showErrorState(messagesEl, "Please enter a name to chat.");
              usernameInput.focus();
              return;
            }
            if (!text && !pendingImageUrl) {
              return;
            }
            
            let finalText = text;
            if (pendingImageUrl) {
              finalText = `IMAGE_URL::${pendingImageUrl}\n${text}`;
              previewRemoveBtn.click();
            }
           
            sendBtn.disabled = true;
            inputEl.value = '';
            wordCountEl.textContent = '0 words';
           
            const handler = google.script.run
              .withSuccessHandler(jsonString => {
                sendBtn.disabled = false;
                try {
                  const messages = JSON.parse(jsonString);
                  renderMessages(messages);
                  inputEl.focus();
                } catch (e) {
                  console.error("Failed to parse messages after sending:", e);
                  Utils.showErrorState(messagesEl, "Failed to parse messages from server.");
                }
              })
              .withFailureHandler(error => {
                sendBtn.disabled = false;
                Utils.showErrorState(messagesEl, `Error sending message: ${error.message}`);
              });
             
            if (currentChat.type === 'global') {
              handler.postMessage(username, finalText);
            } else {
              handler.postDirectMessage(currentChat.email, finalText);
            }
          }
         
          function switchChat(type, email = '', name = '') {
            currentChat = { type, email, name };
            messagesEl.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
           
            if (type === 'global') {
              chatHeader.innerHTML = `<h3 class="text-white font-bold text-lg">Global Chat</h3>`;
              inputEl.placeholder = "Type a message to global chat...";
            } else {
              chatHeader.innerHTML = `<h3 class="text-white font-bold text-lg">Chat with ${name}</h3>`;
              inputEl.placeholder = `Message ${name}...`;
            }
           
            document.querySelectorAll('.user-list-item.active').forEach(el => el.classList.remove('active'));
            const activeEl = (type === 'global') 
              ? document.querySelector('.user-list-item[data-type="global"]')
              : document.querySelector(`.user-list-item[data-email="${email}"]`);
              
            if (activeEl) {
              activeEl.classList.add('active');
            }
           
            fetchCurrentMessages();
          }
         
          function renderUserList(users) {
            const onlineUsers = users.filter(u => u.isOnline);
            const offlineUsers = users.filter(u => !u.isOnline);
            onlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            offlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            
            let html = `
              <div class="user-list-item active" data-type="global">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.002 6.002 0 0111.336 0 4.002 4.002 0 01-5.668 5.668 4.002 4.002 0 01-5.668-5.668z" clip-rule="evenodd" />
                </svg>
                <span class="font-bold text-white">Global Chat</span>
              </div>
            `;
           
            if (users.length === 0) {
              html += `<p class="p-2 text-xs text-gray-400">No other users found.</p>`;
              userListEl.innerHTML = html;
              return;
            }
            
            html += `<h4 class="text-xs font-bold text-gray-400 uppercase p-2 mt-2 flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                      </svg>
                      <span>Online (${onlineUsers.length})</span>
                    </h4>`;
                    
            onlineUsers.forEach(user => {
              html += `
                <div class="user-list-item" data-type="dm" data-email="${user.email}" data-name="${user.username}">
                  <span class="status-dot status-online"></span>
                  <span class="text-gray-200">${user.username}</span>
                </div>
              `;
            });
           
            html += `<h4 class="text-xs font-bold text-gray-400 uppercase p-2 mt-2 flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                      </svg>
                      <span>Offline (${offlineUsers.length})</span>
                    </h4>`;
                    
            offlineUsers.forEach(user => {
              html += `
                <div class="user-list-item" data-type="dm" data-email="${user.email}" data-name="${user.username}">
                  <span class="status-dot status-offline"></span>
                  <span class="text-gray-400">${user.username}</span>
                </div>
              `;
            });
           
            const currentActive = userListEl.querySelector('.user-list-item.active');
            const currentType = currentActive?.dataset.type;
            const currentEmail = currentActive?.dataset.email;
            
            userListEl.innerHTML = html;
            
            if (currentType === 'global') {
              userListEl.querySelector('.user-list-item[data-type="global"]')?.classList.add('active');
            } else if (currentType === 'dm') {
              userListEl.querySelector(`.user-list-item[data-email="${currentEmail}"]`)?.classList.add('active');
            } else {
              userListEl.querySelector('.user-list-item[data-type="global"]')?.classList.add('active');
            }

            userListEl.querySelectorAll('.user-list-item').forEach(el => {
              el.addEventListener('click', () => {
                const type = el.dataset.type;
                if (type === 'global') {
                  switchChat('global');
                } else {
                  switchChat('dm', el.dataset.email, el.dataset.name);
                }
              });
            });
          }
         
          function fetchUserList() {
            google.script.run
              .withSuccessHandler(jsonString => {
                try {
                  const users = JSON.parse(jsonString);
                  if (users && users.error) {
                    Utils.showErrorState(userListEl, users.error);
                  } else {
                    allUsers = users;
                    renderUserList(users);
                  }
                } catch (e) {
                  Utils.showErrorState(userListEl, 'Failed to load users.');
                }
              })
              .withFailureHandler(err => {
                Utils.showErrorState(userListEl, err.message);
              })
              .getUsersWithPresence();
          }
         
          userSearchInput.addEventListener('input', Utils.debounce(() => {
            const searchTerm = userSearchInput.value.toLowerCase();
            const filteredUsers = allUsers.filter(u => u.username.toLowerCase().includes(searchTerm));
            renderUserList(filteredUsers);
            
            if (currentChat.type === 'global') {
              document.querySelector('.user-list-item[data-type="global"]')?.classList.add('active');
            } else {
              document.querySelector(`.user-list-item[data-email="${currentChat.email}"]`)?.classList.add('active');
            }
          }, 300));
         
          // FIXED: Chat image upload button
          sendImageBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Send Image button clicked - showing modal');
            
            if (pendingImageUrl) {
              console.log('Image already pending, removing it first');
              previewRemoveBtn.click();
              return;
            }
            
            // Show modal
            imageUrlInput.value = 'https://';
            imageUrlError.classList.add('hidden');
            imageUrlModalOverlay.classList.remove('hidden');
            
            // Force focus after a brief delay
            setTimeout(() => {
              imageUrlInput.focus();
              imageUrlInput.select();
            }, 100);
            
            console.log('Modal should now be visible');
          });
          previewRemoveBtn.addEventListener('click', () => {
            pendingImageUrl = null;
            previewContainer.classList.add('hidden');
            previewContainer.classList.remove('flex');
            previewImg.src = '';
            previewUrl.textContent = '';
          });

          imageUrlCancel.addEventListener('click', (e) => {
            e.preventDefault();
            imageUrlModalOverlay.classList.add('hidden');
            imageUrlInput.value = '';
            imageUrlError.classList.add('hidden');
          });
          
          // FIXED: Modal submit handler
          imageUrlSubmit.addEventListener('click', (e) => {
            e.preventDefault();
            const imageUrl = imageUrlInput.value.trim();
            
            console.log('Submitting image URL:', imageUrl);
            
            if (Utils.validateUrl(imageUrl)) {
              pendingImageUrl = imageUrl;
              previewContainer.classList.remove('hidden');
              previewContainer.classList.add('flex');
              previewImg.src = imageUrl;
              previewUrl.textContent = imageUrl;
              
              // Hide modal
              imageUrlModalOverlay.classList.add('hidden');
              imageUrlInput.value = '';
              imageUrlError.classList.add('hidden');
              
              console.log('Image URL set successfully:', imageUrl);
              Utils.showSuccessMessage('Image ready to send!', windowEl.querySelector('.window-content'));
            } else {
              console.log('Invalid URL:', imageUrl);
              imageUrlError.textContent = "Invalid URL. Must start with http:// or https://";
              imageUrlError.classList.remove('hidden');
            }
          });
          
          imageUrlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              imageUrlSubmit.click();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              imageUrlCancel.click();
            }
          });

          // Enhanced message sending
          sendBtn.addEventListener('click', sendMessage);
          inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });

          fetchCurrentMessages();
          const chatInterval = setInterval(fetchCurrentMessages, 3000);
          
          if (openWindows[instanceId]) {
            openWindows[instanceId].chatInterval = chatInterval;
          }
        });
      });

      // 4. Enhanced Weather App
      document.getElementById('icon-weather').addEventListener('click', (e) => {
        const defaultCity = "Peachtree City";
        const content = `
        <div id="weather-app-container" class="w-full h-full flex flex-col items-center justify-center p-4">
          <div class="weather-container">
            <div class="search_box">
              <input type="text" placeholder="Enter a city name" id="city" value="${defaultCity}" autocomplete="off"/>
              <button id="search">
                <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </button>
            </div>
            <div id="show" class="w-full">
              <div class="loader-spinner"></div>
            </div>
          </div>
        </div>
        `;
        
        handleAppClick(e, 'weather', 'Weather', content, (windowEl) => {
          let show = windowEl.querySelector("#show");
          let search = windowEl.querySelector("#search");
          let cityVal = windowEl.querySelector("#city");
         
          const getWeather = Utils.debounce((initialLoad = false) => {
            let cityValue = cityVal.value.trim();
           
            if (cityValue.length === 0) {
              Utils.showErrorState(show, 'Please enter a city name');
              return;
            }
           
            show.innerHTML = `<div class="loader-spinner"></div>`;
           
            if (!initialLoad) {
              cityVal.value = "";
            }
           
            google.script.run
              .withSuccessHandler(jsonString => {
                try {
                  const data = JSON.parse(jsonString);
                 
                  if (data.error) {
                    throw new Error(data.detail || data.error);
                  }
                  
                  show.innerHTML = `
                    <div class="fade-in">
                      <h2>${data.name}, ${data.sys.country}</h2>
                      <h4 class="weather">${data.weather[0].main}</h4>
                      <h4 class="desc">${data.weather[0].description}</h4>
                      <img src="https://openweathermap.org/img/w/${data.weather[0].icon}.png" alt="${data.weather[0].description}">
                      <h1>${Math.round(data.main.temp)} &#176;C</h1>
                      <div class="temp_container">
                        <div>
                          <h4 class="title">min</h4>
                          <h4 class="temp">${Math.round(data.main.temp_min)}&#176;C</h4>
                        </div>
                        <div>
                          <h4 class="title">max</h4>
                          <h4 class="temp">${Math.round(data.main.temp_max)}&#176;C</h4>
                        </div>
                      </div>
                    </div>
                  `;
                  cityVal.value = data.name;
                 
                } catch (error) {
                  console.error("Weather data error:", error);
                  Utils.showErrorState(show, error.message);
                }
              })
              .withFailureHandler(error => {
                console.error("Weather script error:", error);
                Utils.showErrorState(show, error.message);
              })
              .fetchWeather(cityValue);
          }, 500);
         
          search.addEventListener("click", () => getWeather(false));
          cityVal.addEventListener("keydown", (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              getWeather(false);
            }
          });
         
          getWeather(true);
        });
      });

      // 5. Enhanced Games App
      document.getElementById('icon-games').addEventListener('click', (e) => {
        const content = `
          <div class="flex flex-col h-full">
            <div id="games-library" class="flex-grow p-4 overflow-auto flex flex-col">
              <h2 class="text-xl font-semibold mb-4 text-gray-200">Game Library</h2>
              <div id="games-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="flex justify-center items-center py-8">
                  <div class="loader" style="display: block; position: relative; margin: 0; top: 0; left: 0;"></div>
                </div>
              </div>
            </div>
            <div id="games-player" class="flex-grow h-full flex-col" style="display: none;">
              <div class="p-2 flex-shrink-0 bg-[#1e1e2e] border-b border-[#313244]">
                <button id="games-back-btn" class="text-sm hover:underline text-[#89b4fa]">&larr; Back to Library ( press Esc)</button>
              </div>
              <div class="flex-grow bg-black">
                <iframe id="games-iframe" class="w-full h-full border-none"></iframe>
              </div>
            </div>
          </div>
        `;
        // I love all races (for all that say that I am racist)
        handleAppClick(e, 'games', 'Games', content, (windowEl, instanceId) => {
          const libraryView = windowEl.querySelector('#games-library');
          const playerView = windowEl.querySelector('#games-player');
          const gameListEl = windowEl.querySelector('#games-list');
          const iframe = windowEl.querySelector('#games-iframe');
          const backBtn = windowEl.querySelector('#games-back-btn');
          let currentGameView = 'library';
          
          function showLibrary() {
            playerView.style.display = 'none';
            libraryView.style.display = 'flex';
            currentGameView = 'library';
            iframe.srcdoc = '';
          }
          
          function loadGame(game) {
            libraryView.style.display = 'none';
            playerView.style.display = 'flex';
            currentGameView = 'player';
            iframe.srcdoc = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #000;"><div class="loader" style="display: block; position: relative; margin: 0;"></div></div>';
            
            google.script.run
              .withSuccessHandler(htmlContent => { 
                iframe.srcdoc = htmlContent; 
                Utils.showSuccessMessage(`Loaded ${game.name}`, windowEl.querySelector('.window-content'));
              })
              .withFailureHandler(error => { 
                iframe.srcdoc = `<div style="padding: 20px; color: #f38ba8; background: #1e1e2e; text-align: center;">
                  <h3>Failed to load game</h3>
                  <p>${error.message}</p>
                </div>`;
              })
              .getGameContent(game.fileName);
          }
          
          const onKeydown = (e) => {
            if (e.key === 'Escape' && currentGameView === 'player' && openWindows[instanceId] && !openWindows[instanceId].minimized) {
              showLibrary();
            }
          };
          
          document.addEventListener('keydown', onKeydown);
          
          if(openWindows[instanceId]) {
            openWindows[instanceId].onKeydownListener = onKeydown;
          }
          
          backBtn.addEventListener('click', showLibrary);
          
          google.script.run
            .withSuccessHandler(jsonGames => {
              try {
                const games = JSON.parse(jsonGames);
                gameListEl.innerHTML = '';
                
                if (games.length === 0) {
                  Utils.showErrorState(gameListEl, 'No games found. Add games to getGameList in Code.gs');
                  return;
                }
                
                games.forEach(game => {
                  const gameCard = document.createElement('button');
                  gameCard.className = "p-4 rounded-lg shadow text-left hover:shadow-md transition-all duration-200 transform hover:scale-105";
                  gameCard.innerHTML = `
                    <h3 class="font-semibold text-lg text-[#89b4fa]">${game.name}</h3>
                    <p class="text-sm text-gray-300 mt-2">${game.description}</p>`;
                  gameCard.addEventListener('click', () => loadGame(game));
                  gameListEl.appendChild(gameCard);
                });
                
              } catch (e) {
                Utils.showErrorState(gameListEl, 'Failed to parse game list');
              }
            })
            .withFailureHandler(error => {
              Utils.showErrorState(gameListEl, `Error loading game list: ${error.message}`);
            })
            .getGameList();
        });
      });

      // 6. Enhanced Draw App
      document.getElementById('icon-draw').addEventListener('click', (e) => {
        const content = `
          <label for="draw-color" class="text-sm font-medium">Color:</label>
          <input type="color" id="draw-color" value="#FFFFFF" class="h-8 w-8 rounded cursor-pointer">
          <label for="draw-size" class="text-sm font-medium">Size:</label>
          <input type="range" id="draw-size" min="1" max="50" value="5" class="w-24">
          <span id="draw-size-display" class="text-xs text-gray-400">5px</span>
          <button id="draw-clear" class="dark-button-gray text-sm px-3 py-1 rounded hover:bg-[#313244] transition">Clear</button>
          <button id="draw-set-bg" class="dark-button-green text-sm px-3 py-1 rounded hover:bg-[#94e2d5] transition">Set as Background</button>
          <button id="draw-download" class="dark-button-gray text-sm px-3 py-1 rounded hover:bg-[#313244] transition">Download</button>
        `;
       
        handleAppClick(e, 'draw', 'Draw', content, (windowEl, instanceId) => {
          const canvas = windowEl.querySelector('#draw-canvas');
          const ctx = canvas.getContext('2d');
          const contentArea = windowEl.querySelector('.window-content');
          const colorPicker = windowEl.querySelector('#draw-color');
          const sizePicker = windowEl.querySelector('#draw-size');
          const sizeDisplay = windowEl.querySelector('#draw-size-display');
          const clearBtn = windowEl.querySelector('#draw-clear');
          const setBgBtn = windowEl.querySelector('#draw-set-bg');
          const downloadBtn = windowEl.querySelector('#draw-download');
          
          let isDrawing = false, lastX = 0, lastY = 0;
          let drawingData = null;
          
          function resizeCanvas(redraw = false) {
            if (redraw && canvas.width > 0) {
              drawingData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            canvas.width = contentArea.clientWidth;
            canvas.height = contentArea.clientHeight;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            if (redraw && drawingData) {
              ctx.putImageData(drawingData, 0, 0);
            }
          }
         
          resizeCanvas(false);
          
          // Enhanced size display
          sizePicker.addEventListener('input', () => {
            sizeDisplay.textContent = `${sizePicker.value}px`;
          });
          
          function draw(e) {
            if (!isDrawing) return;
            ctx.strokeStyle = colorPicker.value;
            ctx.lineWidth = sizePicker.value;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
          }
          
          canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
          });
          canvas.addEventListener('mousemove', draw);
          canvas.addEventListener('mouseup', () => isDrawing = false);
          canvas.addEventListener('mouseout', () => isDrawing = false);
         
          clearBtn.addEventListener('click', () => {
            if (confirm('Clear the entire canvas?')) {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              Utils.showSuccessMessage('Canvas cleared', windowEl.querySelector('.window-content'));
            }
          });
         
          setBgBtn.addEventListener('click', () => {
            const dataUrl = canvas.toDataURL('image/png');
            localStorage.setItem('scriptos_desktop_bg_drawing', dataUrl);
            localStorage.removeItem('scriptos_desktop_bg_image');
            localStorage.removeItem('scriptos_desktop_bg_gradient');
            loadSettings();
            Utils.showSuccessMessage('Set as desktop background', windowEl.querySelector('.window-content'));
          });
          
          // NEW: Download functionality
          downloadBtn.addEventListener('click', () => {
            const dataUrl = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `scriptos-drawing-${Date.now()}.png`;
            link.href = dataUrl;
            link.click();
            Utils.showSuccessMessage('Drawing downloaded', windowEl.querySelector('.window-content'));
          });
         
          const resizeObserver = new ResizeObserver(Utils.debounce(() => resizeCanvas(true), 100));
          resizeObserver.observe(contentArea);
          
          if(openWindows[instanceId]) {
            openWindows[instanceId].resizeObserver = resizeObserver;
          }
        });
      });

      // 7. Enhanced Code Editor App
      document.getElementById('icon-editor').addEventListener('click', (e) => {
        const content = `
          <div class="flex flex-col h-full">
            <div class="p-2 border-b flex justify-between items-center flex-shrink-0" style="border-color: #313244;">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium">Language:</span>
                <select id="code-mode" class="rounded text-sm px-2 py-1 dark-input">
                  <option value="html">HTML / CSS / JS</option>
                  <option value="python">Python (Brython)</option>
                  <option value="typescript">TypeScript</option>
                </select>
              </div>
              <div class="flex gap-2">
                <button id="code-save" class="dark-button-gray text-sm px-3 py-1 rounded">Save</button>
                <button id="code-run" class="dark-button-green text-sm px-3 py-1 rounded">Run</button>
              </div>
            </div>
            <div class="flex-grow flex h-full overflow-hidden">
              <div class="w-1/2 h-full border-r flex flex-col" style="border-color: #313244;">
                <div class="flex justify-between items-center p-2 border-b border-[#313244] text-xs text-gray-400">
                  <span>Code Editor</span>
                  <span id="code-line-count">Lines: 0</span>
                </div>
                <textarea id="code-editor" class="w-full h-full p-2 text-sm no-scrollbar flex-grow" 
                         style="resize: none;" placeholder="Write your code here..."></textarea>
              </div>
              <div class="w-1/2 h-full flex flex-col">
                <div class="flex justify-between items-center p-2 border-b border-[#313244] text-xs text-gray-400">
                  <span>Output</span>
                  <button id="code-fullscreen" class="text-[#89b4fa] hover:text-[#94e2d5]"> Fullscreen</button>
                </div>
                <iframe id="code-preview" class="w-full h-full border-none flex-grow"></iframe>
              </div>
            </div>
          </div>
        `;
        
        handleAppClick(e, 'editor', 'Code Editor', content, (windowEl) => {
          const runBtn = windowEl.querySelector('#code-run');
          const saveBtn = windowEl.querySelector('#code-save');
          const editor = windowEl.querySelector('#code-editor');
          const preview = windowEl.querySelector('#code-preview');
          const modeSelect = windowEl.querySelector('#code-mode');
          const lineCount = windowEl.querySelector('#code-line-count');
          const fullscreenBtn = windowEl.querySelector('#code-fullscreen');
         
          const defaultCode = {
            html: `<!-- Enhanced HTML Example -->\n<style>\n  body { \n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    font-family: 'Arial', sans-serif;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    min-height: 100vh;\n    margin: 0;\n    color: white;\n  }\n  .container {\n    text-align: center;\n    padding: 2rem;\n    backdrop-filter: blur(10px);\n    background: rgba(255,255,255,0.1);\n    border-radius: 20px;\n    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);\n    border: 1px solid rgba(255,255,255,0.18);\n  }\n  h1 { \n    font-size: 3rem; \n    font-weight: bold;\n    margin-bottom: 1rem;\n    background: linear-gradient(45deg, #ff6b6b, #4ecdc4);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n  }\n  .btn {\n    padding: 12px 24px;\n    background: linear-gradient(45deg, #ff6b6b, #ffa500);\n    border: none;\n    border-radius: 25px;\n    color: white;\n    cursor: pointer;\n    font-size: 1rem;\n    transition: transform 0.3s ease;\n  }\n  .btn:hover {\n    transform: scale(1.05);\n  }\n</style>\n\n<div class="container">\n  <h1>ScriptOS Code Editor</h1>\n  <p>This is an enhanced HTML/CSS/JS example!</p>\n  <button class="btn" onclick="showMessage()">Click Me!</button>\n  <div id="output"></div>\n</div>\n\n<script>\n  let clickCount = 0;\n  function showMessage() {\n    clickCount++;\n    document.getElementById('output').innerHTML = \n      \`<p style="margin-top: 1rem; font-size: 1.2rem;">Clicked \${clickCount} time\${clickCount !== 1 ? 's' : ''}! </p>\`;\n    console.log('Button clicked!', clickCount);\n  }\n<\/script>`,
            python: `# Enhanced Python Example with Brython\n# Output from print() appears in console and on page\n\nimport math\nimport random\nfrom browser import document\n\nname = "ScriptOS"\nprint(f" Hello from Python in {name}!")\nprint("=" * 40)\n\n# Math examples\nprint(" Math Examples:")\nfor i in range(5):\n    result = math.sqrt(i ** 2 + 10)\n    print(f"({i} + 10) = {result:.2f}")\n\nprint("\\n Random Numbers:")\nrandom_nums = [random.randint(1, 100) for _ in range(5)]\nprint(f"Generated: {random_nums}")\nprint(f"Sum: {sum(random_nums)}, Average: {sum(random_nums)/len(random_nums):.1f}")\n\n# DOM manipulation\nprint("\\n DOM Manipulation:")\ntry:\n    # Create a colorful message\n    body = document.body\n    body.style.background = "linear-gradient(45deg, #1e3c72, #2a5298)"\n    body.style.color = "white"\n    body.style.fontFamily = "Arial, sans-serif"\n    body.style.padding = "20px"\n    print(" Styled the page background!")\nexcept Exception as e:\n    print(f" DOM error: {e}")`,
            typescript: `// Enhanced TypeScript Example\n// Demonstrates interfaces, classes, generics, and async/await\n\ninterface User {\n  name: string;\n  id: number;\n  email?: string;\n  isActive: boolean;\n}\n\ninterface ApiResponse<T> {\n  data: T;\n  status: 'success' | 'error';\n  timestamp: Date;\n}\n\nclass UserManager<T extends User> {\n  private users: T[] = [];\n  \n  constructor(private readonly maxUsers: number = 100) {\n    console.log(\` UserManager initialized (max: \${maxUsers})\`);\n  }\n  \n  addUser(user: T): boolean {\n    if (this.users.length >= this.maxUsers) {\n      console.warn(' Maximum users reached!');\n      return false;\n    }\n    this.users.push(user);\n    console.log(\` Added user: \${user.name} (ID: \${user.id})\`);\n    return true;\n  }\n  \n  findUserById(id: number): T | undefined {\n    return this.users.find(user => user.id === id);\n  }\n  \n  getActiveUsers(): T[] {\n    return this.users.filter(user => user.isActive);\n  }\n  \n  async simulateApiCall(): Promise<ApiResponse<T[]>> {\n    console.log(' Simulating API call...');\n    \n    // Simulate async operation\n    await new Promise(resolve => setTimeout(resolve, 1000));\n    \n    return {\n      data: this.users,\n      status: 'success',\n      timestamp: new Date()\n    };\n  }\n}\n\n// Usage example\nconst manager = new UserManager<User>(50);\n\n// Add sample users\nconst users: User[] = [\n  { name: 'Alice Johnson', id: 1, email: 'alice@example.com', isActive: true },\n  { name: 'Bob Smith', id: 2, isActive: false },\n  { name: 'Carol Davis', id: 3, email: 'carol@example.com', isActive: true }\n];\n\nusers.forEach(user => manager.addUser(user));\n\n// Find and display users\nconst foundUser = manager.findUserById(2);\nif (foundUser) {\n  console.log(\` Found user: \${foundUser.name}\`);\n}\n\nconst activeUsers = manager.getActiveUsers();\nconsole.log(\` Active users (\${activeUsers.length}):\`, activeUsers.map(u => u.name));\n\n// Async example\nmanager.simulateApiCall()\n  .then(response => {\n    console.log(' API Response:', response);\n    console.log(\` Total users in response: \${response.data.length}\`);\n  })\n  .catch(error => console.error(' API Error:', error));\n\n// Generic function example\nfunction processItems<T>(items: T[], processor: (item: T) => string): string[] {\n  return items.map(processor);\n}\n\nconst userSummaries = processItems(users, user => \n  \`\${user.name} (\${user.isActive ? 'Active' : 'Inactive'})\`\n);\n\nconsole.log(' User Summaries:', userSummaries);\n\n// Try uncommenting this line to see a TypeScript error:\n// const invalidUser: User = { name: 'Invalid', id: 'not-a-number' };`
          };
         
          editor.value = defaultCode[modeSelect.value];
          
          // Enhanced line counter
          const updateLineCount = Utils.debounce(() => {
            const lines = editor.value.split('\\n').length;
            lineCount.textContent = `Lines: ${lines}`;
          }, 100);
          
          editor.addEventListener('input', updateLineCount);
          updateLineCount();
          
          modeSelect.addEventListener('change', () => {
            editor.value = defaultCode[modeSelect.value];
            updateLineCount();
            runCode();
          });
          
          // Enhanced save functionality
          saveBtn.addEventListener('click', () => {
            const mode = modeSelect.value;
            const code = editor.value;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `scriptos-${mode}-${timestamp}.${mode === 'html' ? 'html' : mode === 'python' ? 'py' : 'ts'}`;
            
            const blob = new Blob([code], { type: 'text/plain' });
            const link = document.createElement('a');
            link.download = filename;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
            
            Utils.showSuccessMessage(`Code saved as ${filename}`, windowEl.querySelector('.window-content'));
          });
         
          function runCode() {
            const code = editor.value;
            const mode = modeSelect.value;
            const previewDoc = preview.contentWindow.document;
            previewDoc.open();
           
            if (mode === 'html') {
              previewDoc.write(code);
            } else if (mode === 'python') {
              previewDoc.write(`
                <html>
                  <head>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.11.2/brython.min.js"><\/script>
                    <style>
                      body { 
                        font-family: 'Courier New', monospace; 
                        font-size: 14px; 
                        padding: 10px; 
                        white-space: pre-wrap; 
                        background: linear-gradient(135deg, #1e3c72, #2a5298);
                        color: #cdd6f4;
                        margin: 0;
                        min-height: 100vh;
                        box-sizing: border-box;
                      }
                    </style>
                  </head>
                  <body onload="brython({debug: 0, cache: 'local'})">
                    <script type="text/python">${code}<\/script>
                  </body>
                </html>`);
            } else if (mode === 'typescript') {
              let jsCode = '';
              let error = '';
              try {
                const result = ts.transpileModule(code, { 
                  compilerOptions: { 
                    module: ts.ModuleKind.ES2015,
                    target: ts.ScriptTarget.ES2018,
                    strict: true
                  } 
                });
                jsCode = result.outputText;
              } catch (e) { 
                error = e.message; 
              }
             
              previewDoc.write(`
                <html>
                  <head>
                    <style>
                      body { 
                        font-family: 'Courier New', monospace; 
                        font-size: 14px; 
                        padding: 20px; 
                        white-space: pre-wrap; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: #cdd6f4;
                        margin: 0;
                        min-height: 100vh;
                        box-sizing: border-box;
                      }
                      .error { 
                        color: #f38ba8; 
                        background: rgba(243, 139, 168, 0.1);
                        padding: 10px;
                        border-radius: 5px;
                        border-left: 4px solid #f38ba8;
                      }
                      .success {
                        color: #a6e3a1;
                        background: rgba(166, 227, 161, 0.1);
                        padding: 10px;
                        border-radius: 5px;
                        border-left: 4px solid #a6e3a1;
                        margin-bottom: 10px;
                      }
                    </style>
                  </head>
                  <body>
                    <script>
                      console.log = function(...args) { 
                        document.body.innerHTML += args.join(' ') + '\\n'; 
                      };
                      console.warn = function(...args) { 
                        document.body.innerHTML += '<span style="color: #fab387;"> ' + args.join(' ') + '</span>\\n'; 
                      };
                      console.error = function(...args) { 
                        document.body.innerHTML += '<span style="color: #f38ba8;"> ' + args.join(' ') + '</span>\\n'; 
                      };
                      
                      if ("${error}") {
                        document.body.innerHTML += '<div class="error">TypeScript Compile Error:\\n${error.replace(/'/g, "\\'")} </div>';
                      } else {
                        document.body.innerHTML += '<div class="success"> TypeScript compiled successfully!</div>';
                        try { 
                          ${jsCode.replace(/'/g, "\\'")} 
                        } catch (e) { 
                          document.body.innerHTML += '<div class="error">Runtime Error:\\n' + e.message + '</div>'; 
                        }
                      }
                    <\/script>
                  </body>
                </html>`);
            }
            previewDoc.close();
          }
          
          // Fullscreen preview
          fullscreenBtn.addEventListener('click', () => {
            const previewContent = preview.contentWindow.document.documentElement.outerHTML;
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            newWindow.document.write(previewContent);
            newWindow.document.close();
          });
          
          runBtn.addEventListener('click', runCode);
          
          // Enhanced keyboard shortcuts
          editor.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
              if (e.key === 'Enter') {
                e.preventDefault();
                runCode();
              } else if (e.key === 's') {
                e.preventDefault();
                saveBtn.click();
              }
            }
            // Tab support
            if (e.key === 'Tab') {
              e.preventDefault();
              const start = editor.selectionStart;
              const end = editor.selectionEnd;
              editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
              editor.selectionStart = editor.selectionEnd = start + 2;
            }
          });
          
          runCode();
        });
      });

      // 8. Enhanced Notepad App
      document.getElementById('icon-notepad').addEventListener('click', (e) => {
        const content = `
          <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-2 border-b border-[#313244] text-xs">
              <div class="flex items-center gap-4">
                <span id="notepad-char-count" class="text-gray-400">0 characters</span>
                <span id="notepad-word-count" class="text-gray-400">0 words</span>
                <span id="notepad-line-count" class="text-gray-400">1 line</span>
              </div>
              <div class="flex gap-2">
                <button id="notepad-clear" class="dark-button-red text-xs px-2 py-1 rounded">Clear</button>
                <button id="notepad-download" class="dark-button-gray text-xs px-2 py-1 rounded">Download</button>
              </div>
            </div>
            <textarea id="notepad-text" class="w-full h-full p-3 text-sm resize-none focus:outline-none" 
                      placeholder="Start typing your notes here...&#10;&#10;Your notes are automatically saved to local storage.&#10;&#10;Features:&#10; Auto-save&#10; Character/word/line count&#10; Download as .txt file&#10; Clear all content"></textarea>
          </div>
        `;
        
        handleAppClick(e, 'notepad', 'Notepad', content, (windowEl) => {
          const textarea = windowEl.querySelector('#notepad-text');
          const charCount = windowEl.querySelector('#notepad-char-count');
          const wordCount = windowEl.querySelector('#notepad-word-count');
          const lineCount = windowEl.querySelector('#notepad-line-count');
          const clearBtn = windowEl.querySelector('#notepad-clear');
          const downloadBtn = windowEl.querySelector('#notepad-download');
          
          // Load saved content
          textarea.value = localStorage.getItem('scriptos_notepad') || '';
          
          // Enhanced statistics tracking
          const updateStats = Utils.debounce(() => {
            const text = textarea.value;
            const chars = text.length;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const lines = text.split('\n').length;
            
            charCount.textContent = `${chars} character${chars !== 1 ? 's' : ''}`;
            wordCount.textContent = `${words} word${words !== 1 ? 's' : ''}`;
            lineCount.textContent = `${lines} line${lines !== 1 ? 's' : ''}`;
          }, 100);
          
          textarea.addEventListener('input', () => {
            localStorage.setItem('scriptos_notepad', textarea.value);
            updateStats();
          });
          
          clearBtn.addEventListener('click', () => {
            if (textarea.value.trim() && confirm('Clear all content? This cannot be undone.')) {
              textarea.value = '';
              localStorage.removeItem('scriptos_notepad');
              updateStats();
              Utils.showSuccessMessage('Content cleared', windowEl.querySelector('.window-content'));
            }
          });
          
          downloadBtn.addEventListener('click', () => {
            const content = textarea.value;
            if (!content.trim()) {
              Utils.showErrorState(textarea.parentNode, 'No content to download');
              return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `scriptos-notes-${timestamp}.txt`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.download = filename;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
            
            Utils.showSuccessMessage(`Downloaded as ${filename}`, windowEl.querySelector('.window-content'));
          });
          
          // Keyboard shortcuts
          textarea.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
              if (e.key === 's') {
                e.preventDefault();
                downloadBtn.click();
              } else if (e.key === 'd') {
                e.preventDefault();
                if (e.shiftKey) clearBtn.click();
              }
            }
          });
          
          updateStats();
          textarea.focus();
        });
      });

      // NEW: Calculator App
      document.getElementById('icon-calculator').addEventListener('click', (e) => {
        const content = `
          <div class="flex flex-col h-full bg-[#181825] p-4">
            <input type="text" id="calc-display" class="w-full p-4 text-right text-2xl bg-[#1e1e2e] border border-[#313244] rounded-lg mb-4" readonly>
            <div class="grid grid-cols-4 gap-2">
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">7</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">8</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">9</button>
              <button class="calc-btn dark-button-red text-xl p-4 rounded-lg">/</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">4</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">5</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">6</button>
              <button class="calc-btn dark-button-red text-xl p-4 rounded-lg">*</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">1</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">2</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">3</button>
              <button class="calc-btn dark-button-red text-xl p-4 rounded-lg">-</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">0</button>
              <button class="calc-btn dark-button-gray text-xl p-4 rounded-lg">.</button>
              <button class="calc-btn dark-button-green text-xl p-4 rounded-lg">=</button>
              <button class="calc-btn dark-button-red text-xl p-4 rounded-lg">+</button>
              <button class="calc-clear dark-button-red text-xl p-4 rounded-lg col-span-4">Clear</button>
            </div>
          </div>
        `;
        
        handleAppClick(e, 'calculator', 'Calculator', content, (windowEl) => {
          const display = windowEl.querySelector('#calc-display');
          const buttons = windowEl.querySelectorAll('.calc-btn');
          const clearBtn = windowEl.querySelector('.calc-clear');
          let currentInput = '';
          let operator = '';
          let previousInput = '';
          
          buttons.forEach(btn => {
            btn.addEventListener('click', () => {
              const value = btn.textContent;
              if (['+', '-', '*', '/'].includes(value)) {
                if (currentInput) {
                  previousInput = currentInput;
                  currentInput = '';
                  operator = value;
                }
              } else if (value === '=') {
                if (previousInput && operator && currentInput) {
                  try {
                    currentInput = eval(`${previousInput} ${operator} ${currentInput}`).toString();
                    display.value = currentInput;
                    previousInput = '';
                    operator = '';
                  } catch (err) {
                    display.value = 'Error';
                    currentInput = '';
                  }
                }
              } else if (value === '.') {
                if (!currentInput.includes('.')) {
                  currentInput += value;
                }
              } else {
                currentInput += value;
              }
              display.value = currentInput || '0';
            });
          });
          
          clearBtn.addEventListener('click', () => {
            currentInput = '';
            previousInput = '';
            operator = '';
            display.value = '0';
          });
        });
      });

document.getElementById('icon-settings').addEventListener('click', (e) => {
  const content = `
    <div class="flex h-full bg-[#181825] text-[#cdd6f4] overflow-hidden font-sans">
      <!-- Sidebar -->
      <div class="w-1/4 min-w-[160px] bg-[#1e1e2e]/95 border-r border-[#313244] p-4 flex flex-col gap-3 backdrop-blur-sm">
        <div class="mb-6 pl-2">
          <h3 class="font-bold text-xl bg-clip-text text-transparent bg-gradient-to-r from-[#89b4fa] to-[#cba6f7]">Settings</h3>
          <p class="text-[10px] text-gray-500 uppercase tracking-widest font-semibold mt-1">System v2.1</p>
        </div>
        
        <button class="settings-tab-btn active group flex items-center gap-3 w-full text-left px-4 py-3 rounded-xl text-sm transition-all duration-200 relative overflow-hidden" data-target="appearance">
          <div class="absolute left-0 top-0 bottom-0 w-1 bg-[#89b4fa] opacity-100 transition-opacity"></div>
          <div class="absolute inset-0 bg-[#89b4fa] opacity-10 group-hover:opacity-20 transition-opacity"></div>
          <span class="relative z-10 font-medium text-[#89b4fa]"> Appearance</span>
        </button>

        <button class="settings-tab-btn group flex items-center gap-3 w-full text-left px-4 py-3 rounded-xl text-sm transition-all duration-200 relative overflow-hidden text-gray-400 hover:text-[#cdd6f4]" data-target="personalization">
          <div class="absolute left-0 top-0 bottom-0 w-1 bg-[#fab387] opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
          <div class="absolute inset-0 bg-[#fab387] opacity-0 group-hover:opacity-10 group-[.active]:opacity-10 transition-opacity"></div>
          <span class="relative z-10 group-[.active]:text-[#fab387]"> Personalization</span>
        </button>

        <button class="settings-tab-btn group flex items-center gap-3 w-full text-left px-4 py-3 rounded-xl text-sm transition-all duration-200 relative overflow-hidden text-gray-400 hover:text-[#cdd6f4]" data-target="system">
          <div class="absolute left-0 top-0 bottom-0 w-1 bg-[#a6e3a1] opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
          <div class="absolute inset-0 bg-[#a6e3a1] opacity-0 group-hover:opacity-10 group-[.active]:opacity-10 transition-opacity"></div>
          <span class="relative z-10 group-[.active]:text-[#a6e3a1]"> System</span>
        </button>
      </div>

      <!-- Content Area -->
      <div class="flex-grow p-8 overflow-y-auto custom-scrollbar bg-gradient-to-br from-[#181825] to-[#11111b]">
        
        <!-- Tab: Appearance -->
        <div id="tab-appearance" class="settings-tab-content space-y-10 fade-in">
          
          <!-- OS Themes Section -->
          <div>
            <div class="flex justify-between items-end mb-4 border-b border-[#313244] pb-2">
               <h4 class="text-lg font-bold text-[#89b4fa]">OS Theme Presets</h4>
               <span class="text-xs text-gray-500">Click to apply</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="os-theme-grid">
              <!-- Generated dynamically -->
            </div>
          </div>

          <!-- Gradient Collection -->
          <div>
            <h4 class="text-lg font-bold mb-4 border-b border-[#313244] pb-2 text-[#a6e3a1]">Aesthetic Gradients</h4>
            <div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="gradient-grid">
              <!-- Generated dynamically -->
            </div>
          </div>

          <!-- Solid Colors -->
          <div>
            <h4 class="text-lg font-bold mb-4 border-b border-[#313244] pb-2 text-[#f38ba8]">Solid Colors</h4>
            <div class="flex flex-wrap gap-3" id="solid-color-grid">
               <!-- Generated dynamically -->
            </div>
          </div>

          <!-- Custom URL -->
          <div class="bg-[#1e1e2e]/50 p-4 rounded-xl border border-[#313244]">
             <h4 class="text-sm font-bold text-gray-300 mb-2">Custom Wallpaper URL</h4>
             <div class="flex gap-3">
              <input type="text" id="settings-bg-url" class="flex-grow bg-[#11111b] border border-[#313244] rounded-lg text-sm px-4 py-2 focus:border-[#89b4fa] focus:ring-1 focus:ring-[#89b4fa] outline-none transition-all placeholder-gray-600" placeholder="https://example.com/image.jpg">
              <button id="settings-bg-url-save" class="bg-[#a6e3a1] text-[#11111b] hover:bg-[#94e2d5] transition-colors text-sm px-5 py-2 rounded-lg font-bold shadow-lg shadow-green-900/20">Apply</button>
              <button id="settings-clear-bg" class="bg-[#313244] text-gray-300 hover:bg-[#45475a] transition-colors text-sm px-5 py-2 rounded-lg font-semibold">Reset</button>
            </div>
          </div>
        </div>

        <!-- Tab: Personalization -->
        <div id="tab-personalization" class="settings-tab-content hidden space-y-8 fade-in">
          <div class="bg-[#1e1e2e]/50 p-6 rounded-2xl border border-[#313244]">
            <h4 class="text-lg font-bold mb-6 text-[#fab387] flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
              User Profile
            </h4>
            <div class="space-y-4 max-w-xl">
              <div>
                <label class="block text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wider">Avatar URL</label>
                <div class="flex gap-3">
                  <input type="text" id="settings-avatar-url" class="flex-grow bg-[#11111b] border border-[#313244] rounded-lg text-sm px-4 py-2 focus:border-[#fab387] focus:ring-1 focus:ring-[#fab387] outline-none transition-all placeholder-gray-600" placeholder="https://...">
                  <button id="settings-avatar-url-save" class="bg-[#fab387] text-[#11111b] hover:bg-[#f9e2af] transition-colors text-sm px-5 py-2 rounded-lg font-bold shadow-lg shadow-orange-900/20">Save</button>
                </div>
                <p class="text-[11px] text-gray-500 mt-2 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  Changes reflect in Chat and System Tray
                </p>
              </div>
            </div>
          </div>
          
          <div class="bg-[#1e1e2e]/50 p-6 rounded-2xl border border-[#313244]">
            <h4 class="text-lg font-bold mb-6 text-[#cba6f7] flex items-center gap-2">
               <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
               System Accent
            </h4>
            <div class="max-w-xs">
              <label class="block text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wider">Interface Highlight Color</label>
              <div class="relative">
                <select id="settings-accent" class="w-full appearance-none bg-[#11111b] border border-[#313244] rounded-lg text-sm px-4 py-3 focus:border-[#cba6f7] focus:ring-1 focus:ring-[#cba6f7] outline-none transition-all cursor-pointer">
                  <option value="#89b4fa">Catppuccin Blue (Default)</option>
                  <option value="#f38ba8">Sakura Red</option>
                  <option value="#a6e3a1">Spring Green</option>
                  <option value="#fab387">Peach Orange</option>
                  <option value="#cba6f7">Mauve Purple</option>
                </select>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: System -->
        <div id="tab-system" class="settings-tab-content hidden space-y-8 fade-in">
          <div class="bg-[#1e1e2e]/50 p-6 rounded-2xl border border-[#313244]">
             <h4 class="text-lg font-bold mb-2 text-[#89dceb]">Data Management</h4>
             <p class="text-sm text-gray-400 mb-6 border-b border-[#313244] pb-4">Export your settings to move to another browser or create a backup.</p>
             
             <div class="flex flex-col sm:flex-row gap-4">
                <button id="settings-export" class="flex-1 bg-[#313244] hover:bg-[#45475a] transition-all text-[#cdd6f4] text-sm px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 border border-transparent hover:border-[#89dceb]/50 shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                  Export to JSON
                </button>
                
                <button id="settings-import" class="flex-1 bg-[#313244] hover:bg-[#45475a] transition-all text-[#cdd6f4] text-sm px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 border border-transparent hover:border-[#89dceb]/50 shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                  Import from JSON
                </button>
                <input type="file" id="settings-import-file" class="hidden" accept=".json">
             </div>
          </div>
          
          <div class="bg-[#1e1e2e]/50 p-6 rounded-2xl border border-[#f38ba8]/30">
             <h4 class="text-lg font-bold mb-2 text-[#f38ba8]">Danger Zone</h4>
             <p class="text-sm text-gray-400 mb-6">Irreversible actions that affect your system data.</p>
             <button id="settings-reset-all" class="w-full bg-[#f38ba8]/10 hover:bg-[#f38ba8]/20 border border-[#f38ba8]/50 text-[#f38ba8] text-sm px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
               <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
               Factory Reset OS
             </button>
          </div>
        </div>

      </div>
    </div>
  `;
  
  handleAppClick(e, 'settings', 'Settings', content, (windowEl) => {
    // Define all styling as a string (original base CSS + theme overrides)
    const allStyles = `
      /* --- Base Theme (Inspired by XeroLinux: Dark with blue/neon accents, modern KDE-like) --- */
      body {
        font-family: 'Poppins', sans-serif;
        overflow: hidden;
        background-color: #181825;
        color: #cdd6f4;
        transition: background-color 0.3s ease;
      }
      #desktop {
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        transition: background-image 0.5s ease-in-out;
      }
      /* --- Dock (Latte-like with blur and neon glow) --- */
      footer .dock-container {
        background-color: rgba(30, 30, 46, 0.8);
        backdrop-filter: blur(16px);
        border: 1px solid #313244;
        display: flex;
        align-items: center;
        transition: transform 0.2s ease;
        box-shadow: 0 4px 20px rgba(137, 180, 250, 0.2);
      }
      .dock-icon {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        position: relative;
        background-color: #1e1e2e;
        border-radius: 12px;
      }
      .dock-icon:hover {
        transform: translateY(-8px) scale(1.15);
        background-color: #313244;
        filter: drop-shadow(0 4px 6px rgba(137, 180, 250, 0.3));
      }
      .dock-icon .active-dot {
        display: none;
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background-color: #89b4fa;
        border-radius: 50%;
        box-shadow: 0 0 8px #89b4fa;
      }
      #dock-clock {
        color: #cdd6f4;
        font-family: 'Courier New', Courier, monospace;
        font-weight: 500;
        font-size: 0.9rem;
        margin-left: 1.5rem;
        margin-right: 0.5rem;
        padding: 4px 8px;
        background-color: rgba(30, 30, 46, 0.5);
        border-radius: 6px;
      }
      #dock-battery {
        color: #cdd6f4;
        font-size: 0.9rem;
        margin-left: 1rem;
        padding: 4px 8px;
        background-color: rgba(30, 30, 46, 0.5);
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      #dock-battery svg {
        width: 16px;
        height: 16px;
      }
      /* --- App Windows (With neon borders and glow) --- */
      .app-window {
        min-width: 320px;
        min-height: 250px;
        overflow: hidden;
        background-color: #1e1e2e;
        border: 1px solid #313244;
        box-shadow: 0 10px 20px rgba(137, 180, 250, 0.1);
        display: none;
        flex-direction: column;
        color: #cdd6f4;
        transition: opacity 0.3s ease, transform 0.3s ease;
        opacity: 0;
        transform: scale(0.95);
        border-radius: 12px;
      }
      .app-window.active {
        opacity: 1;
        transform: scale(1);
      }
      .window-header {
        cursor: move;
        flex-shrink: 0;
        background-color: #181825;
        border-bottom: 1px solid #313244;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .window-title {
        color: #cdd6f4;
      }
      .window-content {
        flex-grow: 1;
        background-color: #181825;
        overflow: auto;
        position: relative;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
      }
      
      /* --- Shared form styles --- */
      .dark-input {
        background-color: #181825;
        border: 1px solid #313244;
        color: #cdd6f4;
        transition: border-color 0.2s ease;
      }
      .dark-input:focus {
        outline: 2px solid #89b4fa;
        border-color: #89b4fa;
      }
      .dark-button-green {
        background-color: #a6e3a1;
        color: #181825;
        transition: background-color 0.2s ease;
      }
      .dark-button-green:hover {
        background-color: #94e2d5;
      }
      .dark-button-gray {
        background-color: #1e1e2e;
        border: 1px solid #313244;
        color: #cdd6f4;
        transition: background-color 0.2s ease;
      }
      .dark-button-gray:hover {
        background-color: #313244;
      }
      .dark-button-red {
        background-color: #f38ba8;
        color: #181825;
        transition: background-color 0.2s ease;
      }
      .dark-button-red:hover {
        background-color: #eba0ac;
      }
      
      /* --- Enhanced Loader --- */
      .loader {
        border: 4px solid #313244;
        border-top: 4px solid #89b4fa;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -16px;
        margin-left: -16px;
        display: none;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      
      /* --- 8-WAY RESIZERS --- */
      .resizer {
        position: absolute;
        z-index: 90;
      }
      .resizer.top {
        top: -5px;
        left: 5px;
        right: 5px;
        height: 10px;
        cursor: n-resize;
      }
      .resizer.bottom {
        bottom: -5px;
        left: 5px;
        right: 5px;
        height: 10px;
        cursor: s-resize;
      }
      .resizer.left {
        left: -5px;
        top: 5px;
        bottom: 5px;
        width: 10px;
        cursor: w-resize;
      }
      .resizer.right {
        right: -5px;
        top: 5px;
        bottom: 5px;
        width: 10px;
        cursor: e-resize;
      }
      .resizer.top-left {
        top: -5px;
        left: -5px;
        width: 10px;
        height: 10px;
        cursor: nwse-resize;
      }
      .resizer.top-right {
        top: -5px;
        right: -5px;
        width: 10px;
        height: 10px;
        cursor: nesw-resize;
      }
      .resizer.bottom-left {
        bottom: -5px;
        left: -5px;
        width: 10px;
        height: 10px;
        cursor: nesw-resize;
      }
      .resizer.bottom-right {
        bottom: -5px;
        right: -5px;
        width: 10px;
        height: 10px;
        cursor: nwse-resize;
      }

      /* --- NEW Camera App Styles --- */
      #camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background-color: #000;
      }
      #camera-canvas {
        display: none;
      }
      .camera-controls {
        background-color: #1e1e2e;
        border-top: 1px solid #313244;
        padding: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
      }
      .camera-button {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .camera-capture {
        background-color: #f38ba8;
        color: #181825;
        font-size: 16px;
      }
      .camera-capture:hover {
        background-color: #eba0ac;
        transform: scale(1.05);
      }
      .camera-toggle {
        background-color: #1e1e2e;
        border: 1px solid #313244;
        color: #cdd6f4;
      }
      .camera-toggle:hover {
        background-color: #313244;
      }
      .camera-photos {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 8px;
        background-color: #181825;
      }
      .camera-photo {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
      }
      .camera-photo:hover {
        border-color: #89b4fa;
        transform: scale(1.1);
      }
      .camera-error {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background-color: #1e1e2e;
        color: #f38ba8;
        text-align: center;
        padding: 20px;
      }

      /* --- Enhanced Chat App Styles --- */
      #chat-messages {
        display: flex;
        flex-direction: column;
        gap: 0px;
      }

      .message-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 12px;
        max-width: 90%;
      }
      .message-wrapper.self {
        margin-left: auto;
        flex-direction: row-reverse;
      }
      .message-wrapper.other {
        margin-right: auto;
      }
      .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 4px;
        background-color: #313244;
        object-fit: cover;
      }
      .chat-message {
        padding: 10px 14px;
        border-radius: 18px;
        max-width: 100%;
        width: fit-content;
        text-wrap: wrap;
        word-break: break-word;
      }
      .chat-message p {
        margin: 0;
        color: #cdd6f4;
      }
      .chat-message .sent-image {
        max-width: 250px;
        max-height: 250px;
        object-fit: cover;
        border-radius: 12px;
        margin-bottom: 5px;
        cursor: pointer;
      }
      
      .self-message {
        background-color: #89b4fa;
        border-radius: 18px 18px 4px 18px;
        margin-left: 0;
      }
      .self-message p, .self-message .timestamp {
        color: #181825;
      }
      
      .other-message {
        background-color: #1e1e2e;
        border-radius: 18px 18px 18px 4px;
        margin-right: 0;
      }
      
      .chat-message .username {
        display: block;
        font-weight: 600;
        font-size: 0.8rem;
        margin-bottom: 4px;
        color: #a6adc8;
      }
      
      .self-message .username {
        color: #181825;
      }
      .other-message .username {
        color: #89b4fa;
      }

      .chat-message .timestamp {
        display: block;
        font-size: 0.7rem;
        text-align: right;
        margin-top: 4px;
        color: #6c7086;
      }
      .self-message .timestamp {
        color: #313244;
      }

      /* Role-specific bubble borders */
      .chat-message.admin {
        border: 2px solid #cba6f7;
        box-shadow: 0 0 8px rgba(203, 166, 247, 0.5);
      }
      .chat-message.admin .username {
        color: #cba6f7;
      }

      .chat-message.moderator {
        border: 2px solid #f9e2af;
        box-shadow: 0 0 8px rgba(249, 226, 175, 0.5);
      }
      .chat-message.moderator .username {
        color: #f9e2af;
      }

      .chat-message.canceled {
        border: 2px solid #f38ba8;
        opacity: 0.8;
      }
      .chat-message.canceled .username {
        color: #f38ba8;
        text-decoration: line-through;
      }
      .chat-message.canceled p {
        color: #a6adc8;
        font-style: italic;
      }
      
      .chat-message.contributor {
        border: 2px solid #a6e3a1;
        box-shadow: 0 0 8px rgba(166, 227, 161, 0.5);
      }
      .chat-message.contributor .username {
        color: #a6e3a1;
      }

      /* Chat Sidebar Styles */
      .chat-container {
        flex-direction: row;
        overflow: hidden;
      }
      .chat-sidebar {
        background-color: #181825;
        flex-shrink: 0;
      }
      .chat-main {
        background-color: #181825;
      }
      .user-list-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #313244;
        transition: background-color 0.2s;
      }
      .user-list-item:hover {
        background-color: #1e1e2e;
      }
      .user-list-item.active {
        background-color: #89b4fa;
        color: #181825 !important;
      }
      .user-list-item.active .text-gray-200,
      .user-list-item.active .text-gray-400 {
        color: #181825 !important;
        font-weight: bold;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .status-online {
        background-color: #a6e3a1;
      }
      .status-offline {
        background-color: #6c7086;
      }
      #chat-header {
        background-color: #1e1e2e;
      }

      .chat-v-resizer {
        flex-shrink: 0;
        width: 5px;
        background: #313244;
        cursor: col-resize;
        transition: background 0.2s;
      }
      .chat-v-resizer:hover {
        background: #89b4fa;
      }
      .chat-h-resizer {
        flex-shrink: 0;
        height: 5px;
        background: #313244;
        cursor: row-resize;
        transition: background 0.2s;
      }
      .chat-h-resizer:hover {
        background: #89b4fa;
      }

      /* --- Weather App Styles (Updated for theme) --- */
      #weather-app-container * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        font-family: 'Poppins', sans-serif;
      }
      :root {
        --orange-color: #fab387;
        --dark-color: #cdd6f4;
        --light-color: #181825;
        --background: rgba(30, 30, 46, 0.9);
        --box_shadow: rgba(0, 0, 0, 0.5);
        --border: rgba(255, 255, 255, 0.1);
      }
      #weather-app-container .weather-container {
        width: 90%;
        max-width: 450px;
        height: auto;
        background: var(--background);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        flex-direction: column;
        justify-content: center;
        border-radius: 1rem;
        box-shadow: 0 10px 20px var(--box_shadow);
        padding: 20px;
      }
      .search_box {
        width: 100%;
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        border-radius: 3rem;
        padding: 0.5rem 0.5rem;
        backdrop-filter: blur(4px) saturate(180%);
        box-shadow: 0 5px 10px var(--box_shadow);
        margin-top: 1rem;
        margin-bottom: 2rem;
      }
      .search_box input {
        background: transparent;
        flex: 1;
        border: 0;
        outline: none;
        padding: 0 1rem;
        font-size: 1.4rem;
        color: var(--dark-color);
      }
      .search_box input::placeholder {
        color: var(--dark-color);
        opacity: 0.7;
      }
      .search_box button {
        border: 0;
        border-radius: 50%;
        background: var(--orange-color);
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .search_box .icon-svg {
        width: 18px;
        height: 18px;
        color: var(--light-color);
      }
      .error {
        margin: 4rem 0 5rem 0;
        color: #f38ba8;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 1.2rem;
        letter-spacing: 0.1rem;
        text-align: center;
      }
      #show {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      #show h2 {
        color: var(--dark-color);
        text-transform: uppercase;
        letter-spacing: 0.1rem;
        font-weight: 600;
        font-size: 2rem;
        margin: 1rem 0;
      }
      .weather,
      .desc {
        color: var(--dark-color);
        text-transform: uppercase;
        letter-spacing: 0.1rem;
        font-size: 1.2rem;
        font-weight: 600;
        line-height: 1.5rem;
      }
      .weather {
        margin: 0.5rem 0;
      }
      #show img {
        margin: 1rem 0 0 0;
        width: 80px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
      }
      #show h1 {
        font-size: 5rem;
        margin: 1rem 0;
        line-height: 1;
        font-weight: 400;
        color: var(--dark-color);
      }
      .temp_container {
        display: flex;
        justify-content: center;
        margin: 2rem 0 3rem 0;
        text-align: center;
        width: 100%;
      }
      .temp_container div {
        padding: 0.5rem 1rem;
        flex: 1;
      }
      .temp_container div:first-child {
        border-right: 1px solid var(--border);
      }
      .temp_container .title {
        font-weight: 600;
        color: var(--dark-color);
        font-size: 1.4rem;
        margin-bottom: 4px;
      }
      .temp_container .temp {
        font-weight: 600;
        color: var(--orange-color);
        font-size: 1.4rem;
      }
      .loader-spinner {
        border: 4px solid var(--border);
        border-top: 4px solid var(--orange-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      /* --- Context Menu Styles --- */
      #context-menu {
        position: absolute;
        background-color: #1e1e2e;
        border: 1px solid #313244;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(137, 180, 250, 0.1);
        z-index: 1000;
        display: none;
        min-width: 200px;
        transition: opacity 0.2s ease, transform 0.2s ease;
        opacity: 0;
        transform: translateY(10px);
      }
      #context-menu.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }
      .context-item {
        padding: 8px 16px;
        cursor: pointer;
        color: #cdd6f4;
        transition: background-color 0.2s ease;
      }
      .context-item:hover {
        background-color: #313244;
      }
      .context-separator {
        height: 1px;
        background-color: #313244;
        margin: 4px 0;
      }
      
      .theme-swatch {
        background-size: cover;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .theme-swatch:hover {
        transform: scale(1.1);
        box-shadow: 0 0 8px 2px rgba(137, 180, 250, 0.5);
      }

      /* --- Enhanced Animations --- */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { transform: translateX(-100%); }
        to { transform: translateX(0); }
      }
      
      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }
      
      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      /* --- Error States --- */
      .error-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #f38ba8;
        text-align: center;
      }
      
      .error-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.8;
      }
      
      /* --- Success States --- */
      .success-message {
        background-color: #a6e3a1;
        color: #181825;
        padding: 8px 16px;
        border-radius: 6px;
        margin: 8px 0;
        opacity: 0;
        transform: translateY(-10px);
        animation: successFade 3s ease-out forwards;
      }
      
      @keyframes successFade {
        0% { opacity: 0; transform: translateY(-10px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
      
      /* --- Notification Styles --- */
      #notifications {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 300px;
      }
      .notification {
        background-color: #1e1e2e;
        border: 1px solid #313244;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(137, 180, 250, 0.1);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        color: #cdd6f4;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
      .notification.error {
        border-color: #f38ba8;
        color: #f38ba8;
      }
      .notification.success {
        border-color: #a6e3a1;
        color: #a6e3a1;
      }
      .notification svg {
        width: 20px;
        height: 20px;
      }

      /* Theme Overrides */

      /* MacOS Monterey/Big Sur (unified glossy look, traffic lights left, semi-transparent dock) */
      .theme-macos-monterey body, .theme-macos-big-sur body {
        background-color: #f0f0f0;
        color: #000;
        font-family: 'San Francisco', system-ui;
      }
      .theme-macos-monterey #desktop, .theme-macos-big-sur #desktop {
        background-color: #f0f0f0;
      }
      .theme-macos-monterey footer .dock-container, .theme-macos-big-sur footer .dock-container {
        background-color: rgba(255,255,255,0.8);
        backdrop-filter: blur(20px);
        border: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        border-radius: 20px;
        padding: 4px;
      }
      .theme-macos-monterey .dock-icon, .theme-macos-big-sur .dock-icon {
        background: transparent;
        border-radius: 50%;
        padding: 8px;
      }
      .theme-macos-monterey .dock-icon:hover, .theme-macos-big-sur .dock-icon:hover {
        transform: scale(1.2);
        background: rgba(0,0,0,0.05);
      }
      .theme-macos-monterey .dock-icon .active-dot, .theme-macos-big-sur .dock-icon .active-dot {
        background-color: #000;
        box-shadow: none;
      }
      .theme-macos-monterey #dock-clock, .theme-macos-big-sur #dock-clock {
        color: #000;
        background: transparent;
      }
      .theme-macos-monterey #dock-battery, .theme-macos-big-sur #dock-battery {
        color: #000;
        background: transparent;
      }
      .theme-macos-monterey .app-window, .theme-macos-big-sur .app-window {
        background-color: #fff;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        border-radius: 10px;
        color: #000;
      }
      .theme-macos-monterey .window-header, .theme-macos-big-sur .window-header {
        background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        justify-content: flex-start;
        padding: 6px 12px;
      }
      .theme-macos-monterey .window-header .flex, .theme-macos-big-sur .window-header .flex {
        order: 1;
        gap: 8px;
      }
      .theme-macos-monterey .window-title, .theme-macos-big-sur .window-title {
        order: 2;
        flex-grow: 1;
        text-align: center;
        color: #000;
      }
      .theme-macos-monterey .window-close, .theme-macos-big-sur .window-close {
        order: 1;
        background-color: #ff5f57;
      }
      .theme-macos-monterey .window-minimize, .theme-macos-big-sur .window-minimize {
        order: 2;
        background-color: #ffbd2e;
      }
      .theme-macos-monterey .window-maximize, .theme-macos-big-sur .window-maximize {
        order: 3;
        background-color: #28ca41;
      }
      .theme-macos-monterey .window-content, .theme-macos-big-sur .window-content {
        background-color: #fff;
      }
      .theme-macos-monterey .dark-input, .theme-macos-big-sur .dark-input {
        background-color: #fff;
        border-color: #ccc;
        color: #000;
      }
      .theme-macos-monterey .dark-input:focus, .theme-macos-big-sur .dark-input:focus {
        outline-color: #007aff;
        border-color: #007aff;
      }
      .theme-macos-monterey .dark-button-green, .theme-macos-big-sur .dark-button-green {
        background-color: #28ca41;
        color: #fff;
      }
      .theme-macos-monterey .dark-button-gray, .theme-macos-big-sur .dark-button-gray {
        background-color: #e0e0e0;
        border-color: #ccc;
        color: #000;
      }
      .theme-macos-monterey .dark-button-red, .theme-macos-big-sur .dark-button-red {
        background-color: #ff5f57;
        color: #fff;
      }
      .theme-macos-monterey .chat-message.self-message, .theme-macos-big-sur .chat-message.self-message {
        background-color: #007aff;
        color: #fff;
      }
      .theme-macos-monterey .chat-message.other-message, .theme-macos-big-sur .chat-message.other-message {
        background-color: #e5e5ea;
        color: #000;
      }
      .theme-macos-monterey .chat-sidebar, .theme-macos-big-sur .chat-sidebar {
        background-color: #f0f0f0;
      }
      .theme-macos-monterey .chat-main, .theme-macos-big-sur .chat-main {
        background-color: #fff;
      }
      .theme-macos-monterey #weather-app-container .weather-container, .theme-macos-big-sur #weather-app-container .weather-container {
        background: rgba(255,255,255,0.9);
        color: #000;
      }
      .theme-macos-monterey #context-menu, .theme-macos-big-sur #context-menu {
        background-color: #fff;
        border-color: #ccc;
        color: #000;
      }
      .theme-macos-monterey .notification, .theme-macos-big-sur .notification {
        background-color: #fff;
        border-color: #ccc;
        color: #000;
      }

      /* Windows 11 Light/Dark (modern flat, mica blur, centered taskbar) */
      .theme-windows11-light body {
        background-color: #f3f3f3;
        color: #000;
        font-family: 'Segoe UI', sans-serif;
      }
      .theme-windows11-dark body {
        background-color: #202020;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
      }
      .theme-windows11-light footer .dock-container, .theme-windows11-dark footer .dock-container {
        background-color: rgba(255,255,255,0.5);
        backdrop-filter: blur(20px);
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        justify-content: center;
      }
      .theme-windows11-dark footer .dock-container {
        background-color: rgba(32,32,32,0.8);
      }
      .theme-windows11-light .dock-icon, .theme-windows11-dark .dock-icon {
        background: transparent;
        border-radius: 5px;
        padding: 6px;
      }
      .theme-windows11-light .dock-icon:hover, .theme-windows11-dark .dock-icon:hover {
        background: rgba(0,0,0,0.05);
      }
      .theme-windows11-dark .dock-icon:hover {
        background: rgba(255,255,255,0.05);
      }
      .theme-windows11-light .app-window, .theme-windows11-dark .app-window {
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border-radius: 8px;
        color: #000;
      }
      .theme-windows11-dark .app-window {
        background-color: #242424;
        border-color: #333;
        color: #fff;
      }
      .theme-windows11-light .window-header, .theme-windows11-dark .window-header {
        background-color: #f3f3f3;
        border-bottom: 1px solid #ddd;
        border-radius: 8px 8px 0 0;
      }
      .theme-windows11-dark .window-header {
        background-color: #202020;
        border-bottom-color: #333;
      }
      .theme-windows11-light .window-close, .theme-windows11-dark .window-close {
        background-color: #c42b1c;
      }
      .theme-windows11-light .chat-message.self-message, .theme-windows11-dark .chat-message.self-message {
        background-color: #0078d4;
        color: #fff;
      }
      .theme-windows11-light .chat-message.other-message, .theme-windows11-dark .chat-message.other-message {
        background-color: #e5e5e5;
        color: #000;
      }
      .theme-windows11-dark .chat-message.other-message {
        background-color: #333;
        color: #fff;
      }
      .theme-windows11-light #weather-app-container .weather-container, .theme-windows11-dark #weather-app-container .weather-container {
        background: rgba(255,255,255,0.8);
        color: #000;
      }
      .theme-windows11-dark #weather-app-container .weather-container {
        background: rgba(32,32,32,0.8);
        color: #fff;
      }

      /* Windows 10 (aero-like, colorful title bars) */
      .theme-windows10 body {
        background-color: #0078d7;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
      }
      .theme-windows10 footer .dock-container {
        background-color: rgba(0,0,0,0.6);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255,255,255,0.2);
      }
      .theme-windows10 .dock-icon {
        border-radius: 0;
      }
      .theme-windows10 .app-window {
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        border-radius: 0;
        color: #000;
      }
      .theme-windows10 .window-header {
        background-color: #0078d7;
        color: #fff;
        border-bottom: none;
        border-radius: 0;
      }
      .theme-windows10 .window-close {
        background-color: #e81123;
      }
      .theme-windows10 .chat-message.self-message {
        background-color: #0078d7;
      }
      .theme-windows10 .chat-message.other-message {
        background-color: #eee;
        color: #000;
      }

      /* Windows XP (classic blue taskbar, beveled windows) */
      .theme-windows-xp body {
        background-color: #0f75bc;
        font-family: 'Tahoma', sans-serif;
      }
      .theme-windows-xp footer .dock-container {
        background-color: #246ad1;
        border: none;
        box-shadow: none;
        border-radius: 0;
        padding: 0;
        height: 30px;
      }
      .theme-windows-xp .dock-container::before {
        content: 'Start';
        background-color: #228b22;
        color: white;
        padding: 4px 12px;
        font-weight: bold;
        border-right: 2px outset #fff;
      }
      .theme-windows-xp .dock-icon {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 4px;
      }
      .theme-windows-xp .app-window {
        background-color: #d4d0c8;
        border: 2px outset #d4d0c8;
        box-shadow: none;
        border-radius: 0;
        color: #000;
      }
      .theme-windows-xp .window-header {
        background: linear-gradient(to right, #0f4c81, #3c8dbc);
        color: #fff;
        border-bottom: 1px solid #000;
        padding: 2px;
        border-radius: 0;
      }
      .theme-windows-xp .window-title {
        font-weight: bold;
      }
      .theme-windows-xp .window-minimize, .theme-windows-xp .window-maximize, .theme-windows-xp .window-close {
        width: 20px;
        height: 16px;
        border: 1px outset #d4d0c8;
        background-color: #d4d0c8;
        color: #000;
        font-size: 12px;
        line-height: 14px;
        text-align: center;
        border-radius: 0;
        margin-left: 2px;
      }
      .theme-windows-xp .window-minimize::after { content: '_'; }
      .theme-windows-xp .window-maximize::after { content: ''; }
      .theme-windows-xp .window-close::after { content: 'X'; font-weight: bold; }
      .theme-windows-xp .chat-message {
        border-radius: 0;
        border: 1px solid #ccc;
      }
      .theme-windows-xp .chat-message.self-message {
        background-color: #fff;
        color: #000;
      }
      .theme-windows-xp #weather-app-container .weather-container {
        background: #d4d0c8;
        border: 2px outset #d4d0c8;
        color: #000;
      }

      /* Retro 95 (blocky, gray, teal bg, outset borders) */
      .theme-retro body {
        background-color: #008080;
        font-family: 'MS Sans Serif', 'Arial', sans-serif;
        font-size: 12px;
      }
      .theme-retro #desktop {
        background-color: #008080;
      }
      .theme-retro footer .dock-container {
        background-color: #c0c0c0;
        border-top: 2px solid #fff;
        border-left: 2px solid #fff;
        border-bottom: 2px solid #808080;
        border-right: 2px solid #808080;
        border-radius: 0;
        box-shadow: none;
        padding: 2px;
        height: 28px;
        align-items: stretch;
      }
      .theme-retro .dock-container::before {
        content: 'Start';
        background-color: #c0c0c0;
        border: 1px outset #c0c0c0;
        padding: 4px 8px;
        font-weight: bold;
        margin-right: 4px;
      }
      .theme-retro .dock-icon {
        background-color: #c0c0c0;
        border: 1px dotted #000;
        border-radius: 0;
        padding: 2px;
      }
      .theme-retro .dock-icon:hover {
        transform: none;
        background-color: #808080;
        filter: none;
      }
      .theme-retro .dock-icon .active-dot {
        display: none;
      }
      .theme-retro #dock-clock {
        background-color: #c0c0c0;
        border: 1px inset #808080;
        color: #000;
        font-family: 'MS Sans Serif';
        padding: 2px 4px;
        border-radius: 0;
      }
      .theme-retro #dock-battery {
        background-color: #c0c0c0;
        border: 1px inset #808080;
        color: #000;
        padding: 2px 4px;
        border-radius: 0;
      }
      .theme-retro .app-window {
        background-color: #c0c0c0;
        border: 2px outset #dfdfdf;
        box-shadow: none;
        border-radius: 0;
        color: #000;
      }
      .theme-retro .window-header {
        background: linear-gradient(to right, navy 90%, #1084d0 100%);
        color: #fff;
        border-bottom: 1px solid #000;
        border-radius: 0;
        padding: 3px;
        justify-content: flex-start;
      }
      .theme-retro .window-title {
        font-weight: bold;
        margin-left: 4px;
      }
      .theme-retro .window-header .flex {
        margin-left: auto;
        gap: 2px;
      }
      .theme-retro .window-minimize, .theme-retro .window-maximize, .theme-retro .window-close {
        width: 16px;
        height: 14px;
        background-color: #c0c0c0;
        border: 1px outset #dfdfdf;
        border-radius: 0;
        font-size: 10px;
        line-height: 12px;
        text-align: center;
        color: #000;
      }
      .theme-retro .window-minimize::after { content: '_'; }
      .theme-retro .window-maximize::after { content: ''; }
      .theme-retro .window-close::after { content: 'X'; font-weight: bold; }
      .theme-retro .window-content {
        background-color: #c0c0c0;
        border-radius: 0;
      }
      .theme-retro .dark-input {
        background-color: #fff;
        border: 1px inset #808080;
        color: #000;
      }
      .theme-retro .dark-input:focus {
        border: 1px inset #000080;
        outline: none;
      }
      .theme-retro .dark-button-green {
        background-color: #c0c0c0;
        border: 1px outset #dfdfdf;
        color: #000;
      }
      .theme-retro .dark-button-green:hover {
        background-color: #dfdfdf;
      }
      .theme-retro .dark-button-red {
        background-color: #c0c0c0;
        color: #000;
      }
      .theme-retro .chat-message {
        border-radius: 0;
        border: 1px solid #808080;
        background-color: #fff;
        color: #000;
      }
      .theme-retro .chat-sidebar {
        background-color: #c0c0c0;
      }
      .theme-retro .chat-main {
        background-color: #c0c0c0;
      }
      .theme-retro #weather-app-container .weather-container {
        background: #c0c0c0;
        border: 2px outset #dfdfdf;
        color: #000;
        border-radius: 0;
      }
      .theme-retro #context-menu {
        background-color: #c0c0c0;
        border: 2px outset #dfdfdf;
        border-radius: 0;
        box-shadow: none;
        color: #000;
      }
      .theme-retro .context-item {
        padding: 4px 8px;
      }
      .theme-retro .context-item:hover {
        background-color: navy;
        color: #fff;
      }
      .theme-retro .notification {
        background-color: #c0c0c0;
        border: 1px outset #dfdfdf;
        color: #000;
        border-radius: 0;
      }

      /* Ubuntu (orange/purple, rounded, unity-like) */
      .theme-ubuntu body {
        background-color: #2c001e;
        font-family: 'Ubuntu', sans-serif;
      }
      .theme-ubuntu footer .dock-container {
        background-color: rgba(48,10,36,0.8);
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
      .theme-ubuntu .dock-icon {
        border-radius: 5px;
      }
      .theme-ubuntu .app-window {
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        border-radius: 5px;
        color: #000;
      }
      .theme-ubuntu .window-header {
        background-color: #772953;
        color: #fff;
        border-radius: 5px 5px 0 0;
      }
      .theme-ubuntu .chat-message.self-message {
        background-color: #772953;
      }
      .theme-ubuntu .chat-message.other-message {
        background-color: #eee;
        color: #000;
      }
      .theme-ubuntu #weather-app-container .weather-container {
        background: rgba(255,255,255,0.9);
        color: #000;
        border-radius: 5px;
      }

      /* Mint (green, flat, cinnamon-like) */
      .theme-mint body {
        background-color: #d8dee9;
        color: #2e3440;
        font-family: 'Noto Sans', sans-serif;
      }
      .theme-mint footer .dock-container {
        background-color: rgba(255,255,255,0.9);
        border-top: 1px solid #ccc;
      }
      .theme-mint .dock-icon {
        border-radius: 4px;
      }
      .theme-mint .app-window {
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-radius: 4px;
      }
      .theme-mint .window-header {
        background-color: #87c057;
        color: #fff;
      }
      .theme-mint .chat-message.self-message {
        background-color: #87c057;
      }
      .theme-mint .chat-message.other-message {
        background-color: #f0f0f0;
        color: #000;
      }

      /* Arch Linux (minimal blue/black, i3-like) */
      .theme-arch-linux body {
        background-color: #1793d1;
        font-family: 'DejaVu Sans Mono', monospace;
      }
      .theme-arch-linux footer .dock-container {
        background-color: #000;
        border: none;
        box-shadow: none;
        padding: 0;
      }
      .theme-arch-linux .dock-icon {
        background: #000;
        border: none;
        border-radius: 0;
      }
      .theme-arch-linux .app-window {
        background-color: #000;
        border: 1px solid #1793d1;
        box-shadow: none;
        border-radius: 0;
        color: #fff;
      }
      .theme-arch-linux .window-header {
        background-color: #1793d1;
        border-bottom: 1px solid #000;
        border-radius: 0;
      }
      .theme-arch-linux .chat-message {
        border-radius: 0;
        border: 1px solid #1793d1;
        background-color: #000;
      }

      /* Manjaro (green/black, plasma-like) */
      .theme-manjaro body {
        background-color: #000;
        color: #fff;
        font-family: 'Noto Sans', sans-serif;
      }
      .theme-manjaro footer .dock-container {
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(10px);
        border: 1px solid #35bf5c;
      }
      .theme-manjaro .dock-icon {
        border: 1px solid #35bf5c;
      }
      .theme-manjaro .app-window {
        background-color: #1c1c1c;
        border: 1px solid #35bf5c;
        box-shadow: 0 0 10px #35bf5c;
      }
      .theme-manjaro .window-header {
        background-color: #35bf5c;
        color: #000;
      }
      .theme-manjaro .chat-message.self-message {
        background-color: #35bf5c;
        color: #000;
      }

      /* Fedora (blue, gnome-like) */
      .theme-fedora body {
        background-color: #294172;
        font-family: 'Cantarell', sans-serif;
      }
      .theme-fedora footer .dock-container {
        background-color: rgba(41,65,114,0.8);
        border-radius: 10px;
      }
      .theme-fedora .dock-icon {
        border-radius: 10px;
      }
      .theme-fedora .app-window {
        background-color: #fff;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        border-radius: 10px;
        color: #000;
      }
      .theme-fedora .window-header {
        background-color: #294172;
        color: #fff;
        border-radius: 10px 10px 0 0;
      }
      .theme-fedora .chat-message.self-message {
        background-color: #294172;
      }
      .theme-fedora .chat-message.other-message {
        background-color: #eee;
        color: #000;
      }
    `;

    // Append styles if not present
    let styleEl = document.getElementById('main-style');
    if (!styleEl) {
      styleEl = document.createElement('style');
      styleEl.id = 'main-style';
      styleEl.innerHTML = allStyles;
      document.head.appendChild(styleEl);
    }

    // --- Data for Themes ---
    const osThemes = [
      { name: "MacOS Monterey", type: 'gradient', val: "linear-gradient(to top, #accbee 0%, #e7f0fd 100%)", icon: "", className: "macos-monterey" },
      { name: "MacOS Big Sur", type: 'gradient', val: "linear-gradient(135deg, #f5576c 0%, #f093fb 100%)", icon: "", className: "macos-big-sur" },
      { name: "Windows 11 Light", type: 'gradient', val: "radial-gradient(circle at 50% 50%, #a1c4fd 0%, #c2e9fb 100%)", icon: "", className: "windows11-light" },
      { name: "Windows 11 Dark", type: 'gradient', val: "radial-gradient(circle at 50% 50%, #1e3c72 0%, #2a5298 100%)", icon: "", className: "windows11-dark" },
      { name: "Windows 10", type: 'gradient', val: "linear-gradient(135deg, #0061ff 0%, #60efff 100%)", icon: "", className: "windows10" },
      { name: "Windows XP", type: 'gradient', val: "linear-gradient(to bottom, #2989d8 0%, #2989d8 50%, #7db9e8 50%, #7db9e8 100%)", icon: "", className: "windows-xp" },
      { name: "Retro 95", type: 'color', val: "#008080", icon: "", className: "retro" },
      { name: "Ubuntu", type: 'gradient', val: "linear-gradient(to right, #dd2476, #ff512f)", icon: "", className: "ubuntu" },
      { name: "Mint", type: 'gradient', val: "linear-gradient(to right, #11998e, #38ef7d)", icon: "", className: "mint" },
      { name: "Arch Linux", type: 'gradient', val: "linear-gradient(to right, #243B55, #141E30)", icon: "", className: "arch-linux" },
      { name: "Manjaro", type: 'gradient', val: "linear-gradient(to right, #3ca55c, #b5ac49)", icon: "", className: "manjaro" },
      { name: "Fedora", type: 'gradient', val: "linear-gradient(to right, #29323c, #485563)", icon: "", className: "fedora" },
    ];

    const gradients = [
      { name: "Cyberpunk", val: "linear-gradient(to right, #ff0099, #493240)" },
      { name: "Vaporwave", val: "linear-gradient(to right, #cc2b5e, #753a88)" },
      { name: "V", val: "linear-gradient(to right, #4b6cb7, #182848)" },
      { name: "Sunset", val: "linear-gradient(to right, #ff9966, #ff5e62)" },
      { name: "Ocean", val: "linear-gradient(to top, #09203f 0%, #537895 100%)" },
      { name: "Forest", val: "linear-gradient(135deg, #134e5e 0%, #71b280 100%)" },
      { name: "Space", val: "linear-gradient(to right, #0f2027, #203a43, #2c5364)" },
      { name: "Nebula", val: "linear-gradient(to right, #8e2de2, #4a00e0)" },
      { name: "Fire", val: "linear-gradient(to right, #f12711, #f5af19)" },
      { name: "Night", val: "linear-gradient(to right, #232526, #414345)" },
      { name: "Royal", val: "linear-gradient(to right, #141E30, #243B55)" },
      { name: "Frost", val: "linear-gradient(to right, #004e92, #000428)" },
    ];

    const solidColors = [
      { name: "Nord Dark", val: "#2E3440" },
      { name: "Dracula", val: "#282A36" },
      { name: "Gruvbox", val: "#282828" },
      { name: "Solarized", val: "#002B36" },
      { name: "White", val: "#e6e9ef" },
      { name: "Black", val: "#000000" },
      { name: "Catppuccin", val: "#1e1e2e" },
      { name: "Deep Blue", val: "#0f3460" },
      { name: "Slate", val: "#1f2937" },
      { name: "Zinc", val: "#18181b" },
    ];

    // --- Enhanced Rendering Functions ---
    const osGrid = windowEl.querySelector('#os-theme-grid');
    if (osGrid) {
      osThemes.forEach(theme => {
        const btn = document.createElement('button');
        btn.className = "flex flex-col rounded-xl overflow-hidden border border-[#313244] bg-[#1e1e2e] hover:border-[#89b4fa] hover:shadow-[0_0_15px_rgba(137,180,250,0.15)] hover:-translate-y-1 transition-all duration-300 group";
        
        const banner = document.createElement('div');
        banner.className = "h-16 w-full";
        banner.style.background = theme.val;
        
        const info = document.createElement('div');
        info.className = "p-3 flex items-center gap-2";
        
        const label = document.createElement('span');
        label.className = "text-xs font-bold text-gray-300 group-hover:text-white transition-colors";
        label.textContent = `${theme.icon} ${theme.name}`;

        btn.appendChild(banner);
        info.appendChild(label);
        btn.appendChild(info);
        
        btn.addEventListener('click', () => applyTheme(theme));
        osGrid.appendChild(btn);
      });
    }

    const gradGrid = windowEl.querySelector('#gradient-grid');
    if (gradGrid) {
      gradients.forEach(theme => {
        const btn = document.createElement('button');
        btn.className = "w-full aspect-square rounded-xl border border-[#313244] hover:border-[#a6e3a1] hover:scale-110 hover:shadow-lg transition-all duration-300";
        btn.style.background = theme.val;
        btn.title = theme.name;
        btn.addEventListener('click', () => applyTheme({ type: 'gradient', val: theme.val }));
        gradGrid.appendChild(btn);
      });
    }

    const colorGrid = windowEl.querySelector('#solid-color-grid');
    if (colorGrid) {
      solidColors.forEach(theme => {
        const btn = document.createElement('button');
        btn.className = "w-10 h-10 rounded-full border border-[#313244] hover:border-[#f38ba8] hover:scale-110 hover:shadow-[0_0_10px_currentColor] transition-all duration-300";
        btn.style.backgroundColor = theme.val;
        btn.style.color = theme.val; // for shadow color inheritance
        btn.title = theme.name;
        btn.addEventListener('click', () => applyTheme({ type: 'color', val: theme.val }));
        colorGrid.appendChild(btn);
      });
    }

    // --- Logic ---
    function applyTheme(theme) {
      // Reset others
      localStorage.removeItem('scriptos_desktop_bg_image');
      localStorage.removeItem('scriptos_desktop_bg_drawing');
      
      if (theme.type === 'gradient') {
        localStorage.setItem('scriptos_desktop_bg_gradient', theme.val);
        localStorage.removeItem('scriptos_desktop_bg');
      } else {
        localStorage.setItem('scriptos_desktop_bg', theme.val);
        localStorage.removeItem('scriptos_desktop_bg_gradient');
      }
      
      if (theme.className) {
        localStorage.setItem('scriptos_theme', theme.className);
        document.body.className = `theme-${theme.className}`;
      } else {
        localStorage.removeItem('scriptos_theme');
        document.body.className = '';
      }
      
      loadSettings();
      Utils.showSuccessMessage(`Applied: ${theme.name || 'Theme'}`, windowEl.querySelector('.window-content'));
    }

    // Load saved theme on open
    const savedTheme = localStorage.getItem('scriptos_theme');
    if (savedTheme) {
      document.body.className = `theme-${savedTheme}`;
    }

    // Enhanced Tab Switching
    const tabs = windowEl.querySelectorAll('.settings-tab-btn');
    const contents = windowEl.querySelectorAll('.settings-tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Reset all tabs styles
        tabs.forEach(t => {
          t.classList.remove('active');
        });
        
        // Set active tab styles
        tab.classList.add('active');
        
        const target = tab.dataset.target;
        contents.forEach(c => c.classList.add('hidden'));
        const targetContent = windowEl.querySelector(`#tab-${target}`);
        if(targetContent) {
           targetContent.classList.remove('hidden');
           // Trigger simple re-fade animation
           targetContent.classList.remove('fade-in');
           void targetContent.offsetWidth; // trigger reflow
           targetContent.classList.add('fade-in');
        }
      });
    });

    // Custom URL Input
    windowEl.querySelector('#settings-bg-url-save')?.addEventListener('click', () => {
       const urlInput = windowEl.querySelector('#settings-bg-url');
       if(!urlInput) return;
       const url = urlInput.value;
       if(Utils.validateUrl(url)) {
          localStorage.setItem('scriptos_desktop_bg_image', url);
          localStorage.removeItem('scriptos_desktop_bg_drawing');
          localStorage.removeItem('scriptos_desktop_bg_gradient');
          loadSettings();
          Utils.showSuccessMessage('Custom Wallpaper Applied!', windowEl.querySelector('.window-content'));
       } else {
          Utils.showErrorState(windowEl.querySelector('#tab-appearance'), 'Invalid URL');
       }
    });

    windowEl.querySelector('#settings-clear-bg')?.addEventListener('click', () => {
       localStorage.removeItem('scriptos_desktop_bg_image');
       localStorage.removeItem('scriptos_desktop_bg_gradient');
       localStorage.setItem('scriptos_desktop_bg', '#181825');
       loadSettings();
       Utils.showSuccessMessage('Reset to Default', windowEl.querySelector('.window-content'));
    });

    // Avatar Logic (Safe Mode for No-Backend)
    const avatarInput = windowEl.querySelector('#settings-avatar-url');
    if (typeof google !== 'undefined' && google.script) {
        try {
            google.script.run.withSuccessHandler(email => {
                if(email && avatarInput) avatarInput.value = localStorage.getItem('scriptos_avatar_url_' + email) || '';
            }).getCurrentEmail();
        } catch(e) { console.log('Backend not available'); }
    }

    windowEl.querySelector('#settings-avatar-url-save')?.addEventListener('click', () => {
      if(!avatarInput) return;
      const url = avatarInput.value;
      if(Utils.validateUrl(url)) {
         if (typeof google !== 'undefined' && google.script) {
             google.script.run.withSuccessHandler(email => {
                if(email) {
                  localStorage.setItem('scriptos_avatar_url_' + email, url);
                  Utils.showSuccessMessage('Avatar Saved!', windowEl.querySelector('.window-content'));
                }
             }).getCurrentEmail();
         } else {
             // Fallback for demo mode
             localStorage.setItem('scriptos_avatar_url_demo', url);
             Utils.showSuccessMessage('Avatar Saved (Local)!', windowEl.querySelector('.window-content'));
         }
      }
    });

    // Accent Color
    const accentSelect = windowEl.querySelector('#settings-accent');
    if (accentSelect) {
      accentSelect.value = localStorage.getItem('scriptos_accent_color') || '#89b4fa';
      accentSelect.addEventListener('change', () => {
         localStorage.setItem('scriptos_accent_color', accentSelect.value);
         if(confirm('Reload to apply accent color change?')) location.reload();
      });
    }

    // Export/Import/Reset logic
    windowEl.querySelector('#settings-reset-all')?.addEventListener('click', () => {
       if(confirm('WARNING: This will wipe all local data (Notepad, photos, settings). Continue?')) {
          localStorage.clear();
          location.reload();
       }
    });
    
    const importBtn = windowEl.querySelector('#settings-import');
    const importFile = windowEl.querySelector('#settings-import-file');
    
    if (importBtn && importFile) {
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (e) => {
           const file = e.target.files[0];
           if(file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                 try {
                    const data = JSON.parse(e.target.result);
                    Object.keys(data).forEach(k => {
                       if(k.startsWith('scriptos_')) localStorage.setItem(k, data[k]);
                    });
                    loadSettings();
                    Utils.showSuccessMessage('Settings Imported!', windowEl.querySelector('.window-content'));
                 } catch(err) {
                    const tabSystem = windowEl.querySelector('#tab-system');
                    if(tabSystem) Utils.showErrorState(tabSystem, 'Invalid File');
                 }
              };
              reader.readAsText(file);
           }
        });
    }
    
    windowEl.querySelector('#settings-export')?.addEventListener('click', () => {
       const data = {};
       for(let i=0; i<localStorage.length; i++) {
          const key = localStorage.key(i);
          if(key.startsWith('scriptos_')) data[key] = localStorage.getItem(key);
       }
       const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
       const a = document.createElement('a');
       a.href = URL.createObjectURL(blob);
       a.download = `scriptos-backup-${Date.now()}.json`;
       a.click();
    });
  });
});
      
      // Enhanced settings loader
      function loadSettings() {
        const drawingBg = localStorage.getItem('scriptos_desktop_bg_drawing');
        const imageBg = localStorage.getItem('scriptos_desktop_bg_image');
        const gradientBg = localStorage.getItem('scriptos_desktop_bg_gradient');
        const colorBg = localStorage.getItem('scriptos_desktop_bg');
       
        desktop.style.backgroundImage = 'none';
        desktop.style.backgroundColor = '#181825';
       
        if (drawingBg) {
          desktop.style.backgroundImage = `url(${drawingBg})`;
        } else if (imageBg) {
          desktop.style.backgroundImage = `url(${imageBg})`;
        } else if (gradientBg) {
          desktop.style.backgroundImage = gradientBg;
        } else if (colorBg) {
          desktop.style.backgroundColor = colorBg;
        }
      }
      
      // Enhanced dock clock
      function updateDockClock() {
        const clockEl = document.getElementById('dock-clock');
        if (clockEl) {
          const now = new Date();
          const timeString = now.toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit' 
          });
          clockEl.textContent = timeString;
        }
        setTimeout(updateDockClock, 1000);
      }
      
      // Battery status
      function updateBattery() {
        if ('getBattery' in navigator) {
          navigator.getBattery().then(battery => {
            const levelEl = document.getElementById('battery-level');
            const level = Math.floor(battery.level * 100);
            levelEl.textContent = `${level}%`;
            levelEl.style.color = level < 20 ? '#f38ba8' : level < 50 ? '#fab387' : '#a6e3a1';
            
            battery.addEventListener('levelchange', () => updateBattery());
            battery.addEventListener('chargingchange', () => updateBattery());
          });
        } else {
          document.getElementById('battery-level').textContent = 'N/A';
        }
      }
     
      function checkFirstVisit() {
        const isFirstVisit = localStorage.getItem('firstVisit') === null;
        const modalOverlay = document.getElementById('welcome-modal-overlay');
        const closeBtn = document.getElementById('welcome-close-btn');
        
        if (isFirstVisit) {
          modalOverlay.style.display = 'flex';
          closeBtn.addEventListener('click', () => {
            localStorage.setItem('firstVisit', 'false');
            modalOverlay.style.display = 'none';
          });
        }
      }
      
      function loadUsername() {
        google.script.run
          .withSuccessHandler(username => {
            const usernameEl = document.getElementById('current-username');
            const userBar = document.getElementById('user-info-bar');
            if (username && username.trim()) {
              usernameEl.textContent = username.trim();
              userBar.classList.remove('hidden');
              localStorage.setItem('scriptos_chat_username', username.trim());
            } else {
              userBar.classList.add('hidden');
            }
          })
          .withFailureHandler(() => {
            document.getElementById('user-info-bar').classList.add('hidden');
          })
          .getCurrentUsername();
      }
      
      document.getElementById('logout-btn')?.addEventListener('click', () => {
        google.script.run.withSuccessHandler(email => {
          if(email) {
            localStorage.removeItem('scriptos_avatar_url_' + email);
          }
          localStorage.removeItem('scriptos_chat_username');
          window.location.reload(); 
        }).getCurrentEmail();
      });
      
      // Enhanced context menu with dynamic content
      const contextMenu = document.getElementById('context-menu');
      desktop.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const { pageX: x, pageY: y } = e;
        contextMenu.innerHTML = '';
        
        let items = [];
        
        if (e.target.closest('.dock-icon')) {
          const iconId = e.target.closest('.dock-icon').id;
          const appId = iconId.replace('icon-', '');
          items = [
            { text: `Open ${appId.charAt(0).toUpperCase() + appId.slice(1)}`, action: () => document.getElementById(iconId).click() },
            { separator: true },
            { text: 'Pin to Dock', action: () => console.log('Pin feature not implemented') }
          ];
        } else if (e.target.closest('.app-window')) {
          const windowEl = e.target.closest('.app-window');
          const instanceId = windowEl.id.replace('window-', '');
          items = [
            { text: 'Close Window', action: () => closeApp(instanceId) },
            { text: 'Minimize', action: () => windowEl.querySelector('.window-minimize').click() },
            { text: 'Maximize', action: () => windowEl.querySelector('.window-maximize').click() }
          ];
        } else {
          // Desktop context
          items = [
            { text: 'Open Wiki Browser', action: () => document.getElementById('icon-wikibrowser').click() },
            { text: 'Open Chat', action: () => document.getElementById('icon-chat').click() },
            { text: 'Open Weather', action: () => document.getElementById('icon-weather').click() },
            { text: 'Open Camera', action: () => document.getElementById('icon-camera').click() },
            { separator: true },
            { text: 'Settings', action: () => document.getElementById('icon-settings').click() },
            { text: 'Refresh Desktop', action: () => location.reload() },
            { text: 'Logout', action: () => document.getElementById('logout-btn')?.click() }
          ];
        }
        
        items.forEach(item => {
          if (item.separator) {
            const sep = document.createElement('div');
            sep.className = 'context-separator';
            contextMenu.appendChild(sep);
          } else {
            const el = document.createElement('div');
            el.className = 'context-item';
            el.textContent = item.text;
            el.dataset.action = item.text.toLowerCase().replace(/\s/g, '-');
            el.addEventListener('click', item.action);
            contextMenu.appendChild(el);
          }
        });
        
        // Ensure menu stays within viewport
        const menuWidth = contextMenu.offsetWidth;
        const menuHeight = contextMenu.offsetHeight;
        const adjustedX = Math.min(x, window.innerWidth - menuWidth - 20);
        const adjustedY = Math.min(y, window.innerHeight - menuHeight - 20);
        
        contextMenu.style.left = `${adjustedX}px`;
        contextMenu.style.top = `${adjustedY}px`;
        contextMenu.classList.add('show');
      });
      
      document.addEventListener('click', (e) => {
        if (!contextMenu.contains(e.target)) {
          contextMenu.classList.remove('show');
        }
      });
      
      // Notification function
      function showNotification(message, type = 'success') {
        const notifications = document.getElementById('notifications');
        const notif = document.createElement('div');
        notif.className = `notification ${type} fade-in`;
        notif.innerHTML = `
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            ${type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' : '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'}
          </svg>
          ${message}
        `;
        notifications.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
          notif.style.opacity = 0;
          setTimeout(() => notif.remove(), 300);
        }, 3000);
      }
      
      // Initialize everything
      loadSettings();
      updateDockClock();
      updateBattery();
      checkFirstVisit();
      loadUsername();
      
      console.log(' ScriptOS Enhanced - Loaded successfully!');
    });
  </script>
</body>
</html>
